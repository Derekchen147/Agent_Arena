# AI Agent飞书系统架构设计

## 系统概述

本文档为 AI Agent 飞书系统提供一套完整的软件工程架构设计方案。该系统旨在构建一个类似飞书的协作平台，其中参与者是 AI Agent（称为 "员工"），每个 Agent 可以是不同的 CLI 工具或 AI 模型，它们能够在统一的会话界面中进行协作，共同完成复杂任务。

## 整体架构设计

### 1. 系统架构图

```Plain

┌─────────────────────────────────────────────────────────────────────┐
│                         前端展示层 (Web UI)                          │
├─────────────────┬─────────────────┬─────────────────────────────────┤
│  对话记录面板   │  对话空间面板   │        员工状态面板              │
│  (左侧)         │  (中间)         │  (右侧：Agent列表、状态、动画)   │
└─────────────────┴─────────────────┴─────────────────────────────────┘
                              │
┌─────────────────────────────┼─────────────────────────────────────┐
│                         后端服务层                                  │
├─────────────────┬─────────────────┬─────────────────┬─────────────┤
│  会话管理服务   │  Agent协调服务   │  交互逻辑服务   │  记忆管理   │
│                 │                 │                 │  服务       │
└─────────────────┴─────────────────┴─────────────────┴─────────────┘
                              │
┌─────────────────────────────┼─────────────────────────────────────┐
│                         Agent执行层                                │
├─────────────────┬─────────────────┬─────────────────┬─────────────┤
│  Agent适配器    │  Agent容器      │  技能注册中心   │  Token优化  │
│  (适配各种CLI)  │  (进程管理)     │                 │  框架       │
└─────────────────┴─────────────────┴─────────────────┴─────────────┘
                              │
┌─────────────────────────────┼─────────────────────────────────────┐
│                         基础设施层                                  │
├─────────────────┬─────────────────┬─────────────────┬─────────────┤
│  向量数据库     │  关系数据库     │  消息队列       │  监控告警   │
│  (长期记忆)     │  (会话数据)     │                 │             │
└─────────────────┴─────────────────┴─────────────────┴─────────────┘
```

### 2. 架构分层说明

#### 前端展示层

- **对话记录面板**：显示历史会话群组，支持会话切换和管理

- **对话空间面板**：核心交互区域，支持消息发送、@提及、文件上传等

- **员工状态面板**：显示当前在线的 AI 员工列表、各自状态和工作动画

#### 后端服务层

- **会话管理服务**：负责会话的创建、销毁、消息存储和检索

- **Agent 协调服务**：管理 Agent 的生命周期、负载均衡和资源分配

- **交互逻辑服务**：实现 Agent 之间的交互规则和响应机制

- **记忆管理服务**：处理短期记忆和长期记忆的存储与检索

#### Agent 执行层

- **Agent 适配器**：适配各种 CLI 工具和 AI 模型，统一输入输出格式

- **Agent 容器**：管理 Agent 进程的创建、销毁和资源隔离

- **技能注册中心**：存储每个 Agent 的技能描述和能力边界

- **Token 优化框架**：实现上下文压缩、缓存和 Token 使用优化

#### 基础设施层

- **向量数据库**：存储长期记忆的向量表示，支持语义检索

- **关系数据库**：存储会话元数据、Agent 配置等结构化数据

- **消息队列**：实现异步消息传递和解耦服务间通信

- **监控告警**：系统性能监控、Agent 状态监控和异常告警

## 核心模块设计

### 1. Agent 交互规范模块

#### 1.1 通信协议设计

采用 A2A（Agent-to-Agent）协议作为核心通信协议，兼容 MCP 和 ACP 协议：

```json

{
  "message_id": "uuid",
  "sender": "agent_id",
  "receiver": ["agent_id1", "agent_id2"],
  "timestamp": "2026-02-13T00:21:00Z",
  "performative": "inform/request/propose/accept",
  "content": {
    "type": "text/json/file",
    "data": "message content",
    "metadata": {
      "context_id": "session_id",
      "task_id": "task_id",
      "priority": "high/medium/low",
      "requires_response": true/false
    }
  },
  "skill_tags": ["project-management", "code-development"],
  "token_budget": 4096
}
```

#### 1.2 交互逻辑设计

**响应机制**：

- **@提及强制响应**：被 @的 Agent 必须响应，跳过判断过程

- **主动判断响应**：未被 @的 Agent 根据消息内容和自身技能判断是否需要响应

- **超级管理员协调**：可选的协调 Agent 负责任务分配和冲突解决

**交互模式**：

- **点对点模式**：Agent 之间直接通信，适用于线性任务流程

- **广播模式**：向所有 Agent 发送消息，适用于通知和公告

- **黑板模式**：所有 Agent 将结果发布到公共区域，由协调者决定下一步行动

### 2. Agent 技能管理模块

#### 2.1 技能描述框架

每个 Agent 都有一个标准化的技能描述文件（Agent Card）：

```json

{
  "agent_id": "project_manager_001",
  "name": "项目经理",
  "description": "负责需求分析、任务拆解和项目管理",
  "skills": [
    {
      "skill_id": "requirement_analysis",
      "name": "需求分析",
      "description": "分析用户需求并拆解为具体任务",
      "input_format": "用户需求文本",
      "output_format": "任务分解结构JSON",
      "token_cost": 2048
    },
    {
      "skill_id": "project_planning",
      "name": "项目规划",
      "description": "制定项目计划和时间表",
      "input_format": "任务列表",
      "output_format": "项目计划甘特图数据",
      "token_cost": 4096
    }
  ],
  "supported_protocols": ["A2A", "MCP"],
  "memory_capacity": "long_term",
  "response_time": "medium",
  "reliability": "high"
}
```

#### 2.2 技能注册中心

- 集中管理所有 Agent 的技能描述

- 支持技能发现和能力匹配

- 动态更新 Agent 技能配置

- 提供技能调用的权限控制

### 3. 记忆系统模块

#### 3.1 记忆分层设计

**短期记忆（工作记忆）**：

- 存储当前会话的上下文信息

- 使用滑动窗口机制管理上下文长度

- 采用摘要技术压缩冗余信息

- 每个会话独立隔离

**长期记忆（知识库）**：

- 存储跨会话的长期知识和经验

- 使用向量数据库进行语义存储

- 支持相似度检索和知识召回

- 按项目或领域进行分类组织

#### 3.2 记忆管理流程

```Plain

┌─────────────────────────────────────────────────────────────┐
│                     记忆管理流程                             │
├─────────────────┬───────────────────────────────────────────┤
│  1. 记忆捕获    │  从对话中提取关键信息和决策点             │
├─────────────────┼───────────────────────────────────────────┤
│  2. 记忆处理    │  向量化、摘要生成、知识提炼               │
├─────────────────┼───────────────────────────────────────────┤
│  3. 记忆存储    │  短期记忆存入缓存，长期记忆存入向量数据库 │
├─────────────────┼───────────────────────────────────────────┤
│  4. 记忆检索    │  根据当前查询语义检索相关记忆             │
├─────────────────┼───────────────────────────────────────────┤
│  5. 记忆注入    │  将相关记忆融入当前上下文进行推理         │
└─────────────────┴───────────────────────────────────────────┘
```

### 4. Token 优化框架

#### 4.1 多层级优化策略

**上下文压缩层**：

- 移除礼貌性虚词和重复表述

- 使用信息论算法保留关键信息

- 动态调整压缩比率（建议不超过 70%）

**知识分层层**：

- 静态知识存入 RAG 库，动态逻辑保留在 Prompt 中

- 高频问题启用语义缓存机制

- 支持缓存 TTL 动态调整

**按需检索层**：

- 采用渐进式检索策略

- 只加载与当前任务相关的记忆片段

- 实现 "按需读取" 而非 "全文加载"

#### 4.2 Token 预算管理

- 为每个 Agent 配置 Token 预算上限

- 实时监控 Token 使用情况

- 当接近预算上限时自动触发压缩策略

- 支持动态调整 Token 分配策略

## 技术选型建议

### 1. 编程语言选择

**强烈推荐选择 Python**，理由如下：

- 您本人熟悉 Python，便于后续开发和维护

- Python 拥有丰富的 AI/ML 生态和库

- 大多数 Agent 框架和工具都提供 Python SDK

- 开发效率高，适合快速迭代

- 对本地文件系统操作支持良好

### 2. 核心技术栈

#### 后端技术栈

- **框架**：FastAPI / Flask（轻量级、高性能）

- **本地存储**：

    - 文件系统：使用 JSON/YAML 文件存储会话数据和配置

    - 内存缓存：使用 Python 字典和队列实现内存缓存

    - 索引文件：使用 SQLite 实现轻量级本地索引（可选）

- **进程管理**：Python `subprocess` 模块 + `psutil`（Agent 进程管理）

- **异步通信**：使用 Python `asyncio` 实现异步任务处理

#### 前端技术栈

- **框架**：React / Vue.js（现代化前端框架）

- **UI 组件库**：Ant Design / Element Plus（企业级 UI 组件）

- **状态管理**：Redux / Pinia（管理全局状态）

- **实时通信**：[Socket.io](Socket.io)（实现实时消息推送）

#### AI 技术栈

- **LLM 集成**：LangChain / LlamaIndex（Agent 框架，支持本地部署）

- **文本处理**：NLTK /spaCy（文本摘要、关键词提取）

- **工具调用**：自定义 JSON 协议（轻量级本地通信）

## 可扩展性设计

### 1. 模块化设计

- 每个功能模块独立封装，降低耦合度

- 采用接口驱动的设计，便于替换实现

- 支持插件式扩展，动态加载新功能

- 基于文件系统的插件目录结构，便于添加新 Agent

### 2. 本地扩展能力

- 支持多进程并发处理，充分利用本地 CPU 资源

- 内存缓存优化，提高本地访问速度

- 文件系统分区存储，便于数据管理

### 3. 协议兼容性

- 兼容主流的 Agent CLI 工具输出格式

- 支持自定义协议适配器

- 提供标准化的 API 接口

### 4. 多项目支持

- 支持多个项目隔离，基于文件系统目录结构

- 资源配额和权限管理

- 数据隔离和安全保障

## 安全设计

### 1. 本地文件安全

- 文件系统权限控制，限制 Agent 进程访问范围

- 敏感文件加密存储

- 定期备份和恢复机制

### 2. 数据安全

- 本地数据传输加密

- 敏感信息脱敏处理

- 会话数据自动清理策略

### 3. Agent 安全

- Agent 进程隔离，使用独立的工作目录

- 输入输出内容安全检查

- 进程资源限制，防止恶意消耗系统资源

## 监控与运维

### 1. 系统监控

- 本地资源使用监控（CPU、内存、磁盘、网络）

- 进程状态监控

- 错误率和异常监控

### 2. Agent 监控

- Agent 在线状态监控

- Agent 响应时间监控

- Token 使用量监控

- 技能调用成功率监控

### 3. 日志管理

- 本地文件日志记录

- 日志轮转和压缩

- 日志检索和简单分析工具

## 实施路线图

### 第一阶段：基础框架搭建（1-2 个月）

1. 搭建基础服务架构

2. 实现核心会话管理功能（基于本地文件存储）

3. 开发 Agent 适配器框架

4. 实现基本的交互逻辑

### 第二阶段：核心功能开发（2-3 个月）

1. 开发记忆系统模块（内存 + 本地文件）

2. 实现 Token 优化框架

3. 开发技能注册中心（基于 JSON 配置文件）

4. 实现前端界面

### 第三阶段：高级功能完善（1-2 个月）

1. 实现高级交互逻辑

2. 开发本地监控工具

3. 完善安全机制

4. 进行性能优化

### 第四阶段：测试与部署（1 个月）

1. 系统集成测试

2. 本地性能测试

3. 安全测试

4. 打包发布为桌面应用或本地服务

## 总结

本架构设计方案提供了一套轻量级的 AI Agent 飞书系统解决方案，专门针对本地部署优化，具有以下特点：

1. **纯本地实现**：不依赖任何外部数据库或消息队列中间件，所有数据均存储在本地文件系统中

2. **轻量级部署**：系统资源占用低，适合个人使用或小规模部署

3. **模块化设计**：各个功能模块解耦，便于开发和维护

4. **性能优化**：多层级 Token 优化策略，降低成本

5. **安全可靠**：完善的本地安全机制和监控体系

6. **技术选型合理**：基于 Python 生态，充分利用您已有的技术经验

该架构能够满足您的需求，支持多个 AI Agent 在统一的会话界面中进行协作，实现复杂任务的分布式处理。同时，架构设计充分考虑了可扩展性和可维护性，为后续功能扩展和业务发展提供了良好的基础。

由于采用纯本地实现，系统部署和维护成本大幅降低，非常适合作为个人项目或小型团队协作工具使用。您可以基于此架构快速开发出可用的原型系统，并根据实际使用情况逐步完善和扩展功能。
> （注：文档部分内容可能由 AI 生成）