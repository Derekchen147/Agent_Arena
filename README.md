# Agent Arena â€” æ¶æ„è®¾è®¡ï¼ˆClaude ç‰ˆï¼‰

> å¤š AI å‘˜å·¥åä½œç³»ç»Ÿï¼šä¸€ä¸ªã€Œé£ä¹¦å¼ã€çš„ Agent ç¾¤ç»„å·¥ä½œå¹³å°ã€‚
> æœ¬æ–‡æ¡£æ˜¯å¯è½åœ°çš„å·¥ç¨‹æ¶æ„ï¼Œä¸æ˜¯æ¦‚å¿µå †ç Œã€‚æ¯ä¸ªæ¨¡å—éƒ½ç»™å‡ºäº†æ¸…æ™°çš„èŒè´£è¾¹ç•Œã€æ¥å£å®šä¹‰å’Œå…³é”®å®ç°æ€è·¯ã€‚

---

uvicorn src.main:app --reload 

npm run dev


## é›¶ã€æ ¸å¿ƒç†å¿µï¼šæˆ‘ä»¬åœ¨åšä»€ä¹ˆï¼Œä¸åœ¨åšä»€ä¹ˆ

**åœ¨åšä»€ä¹ˆï¼š**
æˆ‘ä»¬è¦åšä¸€ä¸ª**åä½œå¹³å°**â€”â€”æŠŠå¤šä¸ªå·²æœ‰çš„ AI Agentï¼ˆClaude CLIã€Cursor CLIã€æˆ–ä»»ä½• Str-in/Str-out çš„æœåŠ¡ï¼‰ç»„ç»‡æˆä¸€ä¸ªã€Œè™šæ‹Ÿå›¢é˜Ÿã€ï¼Œåœ¨ç»Ÿä¸€çš„ä¼šè¯ç•Œé¢ä¸­åä½œå®Œæˆä»»åŠ¡ã€‚ç³»ç»Ÿæœ¬èº«**ä¸æ›¿ä»£ Agent çš„èƒ½åŠ›**ï¼Œåªåšä¸‰ä»¶äº‹ï¼š
1. **è·¯ç”±** â€”â€” å†³å®šè°æ”¶åˆ°ä»€ä¹ˆæ¶ˆæ¯ã€è°å¿…é¡»å›å¤
2. **é€‚é…** â€”â€” æŠŠä¸åŒ CLI/API çš„è¾“å…¥è¾“å‡ºè½¬æˆç»Ÿä¸€æ ¼å¼
3. **è®°å¿†** â€”â€” ç®¡ç†ä¼šè¯ä¸Šä¸‹æ–‡ï¼ŒæŒ‰éœ€æ³¨å…¥ç»™æ¯ä¸ª Agent

**ä¸åœ¨åšä»€ä¹ˆï¼š**
æˆ‘ä»¬ä¸æ˜¯åˆä¸€ä¸ªã€Œå¤šæ™ºèƒ½ä½“ç¼–æ’æ¡†æ¶ã€ï¼ˆå¦‚ CrewAIã€AutoGenï¼‰ã€‚é‚£äº›æ¡†æ¶çš„ç›®æ ‡æ˜¯æŠŠå¤šä¸ª Agent ç¼–æ’æˆä¸€ä¸ªæµæ°´çº¿ï¼Œæœ€ç»ˆè¾“å‡ºä¸€ä¸ªç»“æœã€‚æˆ‘ä»¬çš„ç›®æ ‡æ˜¯è®©å¤šä¸ª**ç‹¬ç«‹çš„ã€å·²ç¼–æ’å¥½çš„** Agent åƒçœŸäººä¸€æ ·åœ¨ç¾¤é‡Œåä½œã€‚æ¯ä¸ªã€Œå‘˜å·¥ã€æœ¬èº«å¯èƒ½å°±æ˜¯ä¸€ä¸ªå¤æ‚çš„ Agent ç³»ç»Ÿï¼Œä½†åœ¨æˆ‘ä»¬çš„å¹³å°é‡Œï¼Œå®ƒå°±æ˜¯ä¸€ä¸ªèƒ½å¯¹è¯çš„èŠ‚ç‚¹ã€‚

---

## ä¸€ã€è¯­è¨€é€‰å‹ï¼šPythonï¼Œä¸çŠ¹è±«

| è€ƒé‡å› ç´  | ç»“è®º |
|---------|------|
| ä½ ä¼š Python | èƒ½çœ‹æ‡‚ã€èƒ½æ”¹ã€èƒ½ç»´æŠ¤ï¼Œè¿™æ˜¯æœ€å¤§çš„ä¼˜åŠ¿ |
| AI ç”Ÿæ€ | LangChainã€LlamaIndexã€å„å®¶ SDK å…¨åœ¨ Python ç”Ÿæ€ |
| CLI é›†æˆ | `subprocess`ã€`asyncio` å¤©ç„¶é€‚åˆç®¡ç† CLI è¿›ç¨‹ |
| å‰ç«¯æ€ä¹ˆåŠ | å‰ç«¯ç”¨ä»»ä½•æ¡†æ¶ï¼ˆReact/Vue/Svelteï¼‰ï¼Œåç«¯æä¾› API + WebSocketï¼Œå‰åç«¯åˆ†ç¦» |
| TS çš„ä¼˜åŠ¿ | ç±»å‹å®‰å…¨ç¡®å®å¥½ï¼Œä½†ä½ ç°åœ¨ä¸ä¼š TSï¼Œå­¦ä¹ æˆæœ¬ä¼šæ‹–æ…¢ MVP |

**æœ€ç»ˆå»ºè®®ï¼š**
- **åç«¯**ï¼šPython 3.11+ï¼ŒFastAPIï¼ˆå¼‚æ­¥ã€WebSocket åŸç”Ÿæ”¯æŒã€è‡ªåŠ¨ç”Ÿæˆ API æ–‡æ¡£ï¼‰
- **å‰ç«¯**ï¼šéšä½ é€‰ï¼Œæ¨è React + TypeScriptï¼ˆå‰ç«¯é‚£è¾¹ TS æ˜¯æ ‡é…ï¼Œä¸” UI ç»„ä»¶åº“ä¸°å¯Œï¼‰
- **åè®®å®šä¹‰**ï¼šç”¨ JSON Schema / Pydantic Modelï¼Œè¯­è¨€æ— å…³ï¼Œå‰åç«¯éƒ½èƒ½ç”¨

---

## äºŒã€ç³»ç»Ÿæ¶æ„æ€»è§ˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        å‰ç«¯ (React / Vue)                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ ç¾¤ç»„åˆ—è¡¨ä¾§æ  â”‚  â”‚   å¯¹è¯ç©ºé—´ä¸»åŒº   â”‚  â”‚ å‘˜å·¥çŠ¶æ€é¢æ¿ + åŠ¨ç”»  â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚ HTTP + WebSocket
                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      API ç½‘å…³ (FastAPI)                              â”‚
â”‚  REST: ç¾¤ç»„/å‘˜å·¥/æ¶ˆæ¯ CRUD    WebSocket: å®æ—¶æ¶ˆæ¯ + å‘˜å·¥çŠ¶æ€æ¨é€     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â–¼                  â–¼                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ä¼šè¯ç®¡ç†å™¨       â”‚ â”‚ ç¼–æ’å¼•æ“     â”‚ â”‚ å‘˜å·¥è¿è¡Œæ—¶        â”‚
â”‚  SessionManager  â”‚ â”‚ Orchestrator â”‚ â”‚ WorkerRuntime    â”‚
â”‚                  â”‚ â”‚              â”‚ â”‚                  â”‚
â”‚ â€¢ ç¾¤ç»„ CRUD      â”‚ â”‚ â€¢ è°è¯¥å›å¤   â”‚ â”‚ â€¢ è¿›ç¨‹ç”Ÿå‘½å‘¨æœŸ    â”‚
â”‚ â€¢ æ¶ˆæ¯å­˜å‚¨       â”‚â—„â”‚ â€¢ å…¥å‚ç»„è£…   â”‚â–ºâ”‚ â€¢ Adapter è°ƒç”¨   â”‚
â”‚ â€¢ æˆå‘˜ç®¡ç†       â”‚ â”‚ â€¢ å›åˆæ§åˆ¶   â”‚ â”‚ â€¢ æµå¼è¾“å‡ºè½¬å‘    â”‚
â”‚ â€¢ æ¶ˆæ¯å†å²æŸ¥è¯¢   â”‚ â”‚ â€¢ é˜²å¾ªç¯     â”‚ â”‚ â€¢ çŠ¶æ€äº‹ä»¶ä¸ŠæŠ¥    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                  â”‚                   â”‚
         â”‚           â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”           â”‚
         â”‚           â”‚ ä¸Šä¸‹æ–‡æ„å»ºå™¨ â”‚           â”‚
         â”‚           â”‚ ContextBuilderâ”‚          â”‚
         â”‚           â”‚              â”‚           â”‚
         â”‚           â”‚ â€¢ æ¶ˆæ¯æˆªæ–­   â”‚           â”‚
         â”‚           â”‚ â€¢ è®°å¿†æ£€ç´¢   â”‚           â”‚
         â”‚           â”‚ â€¢ æ‘˜è¦ç”Ÿæˆ   â”‚           â”‚
         â”‚           â”‚ â€¢ Token é¢„ç®— â”‚           â”‚
         â”‚           â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
         â”‚                  â”‚                   â”‚
         â–¼                  â–¼                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        æ•°æ®å±‚                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ SQLite/PG   â”‚  â”‚ æ–‡ä»¶ç³»ç»Ÿ     â”‚  â”‚ å‘˜å·¥ & æŠ€èƒ½æ³¨å†Œè¡¨          â”‚ â”‚
â”‚  â”‚ æ¶ˆæ¯/ç¾¤ç»„   â”‚  â”‚ è®°å¿†å¿«ç…§     â”‚  â”‚ AgentRegistry              â”‚ â”‚
â”‚  â”‚ å…ƒæ•°æ®      â”‚  â”‚ é¡¹ç›®æ–‡ä»¶     â”‚  â”‚ â€¢ å‘˜å·¥ Profile             â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ â€¢ Skill é…ç½®               â”‚ â”‚
â”‚                                     â”‚ â€¢ Adapter ç±»å‹æ˜ å°„          â”‚ â”‚
â”‚                                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**æ¨¡å—æ•°é‡æ§åˆ¶åœ¨ 6 ä¸ª**ï¼Œæ¯ä¸ªèŒè´£å•ä¸€ï¼š

| # | æ¨¡å— | ä¸€å¥è¯èŒè´£ |
|---|------|-----------|
| 1 | SessionManager | ç®¡æ•°æ®ï¼šç¾¤ç»„ã€æ¶ˆæ¯ã€æˆå‘˜ |
| 2 | Orchestrator | ç®¡é€»è¾‘ï¼šè°å›å¤ã€ä»€ä¹ˆé¡ºåº |
| 3 | ContextBuilder | ç®¡ä¸Šä¸‹æ–‡ï¼šæˆªæ–­ã€æ‘˜è¦ã€è®°å¿†æ£€ç´¢ã€Token é¢„ç®— |
| 4 | WorkerRuntime | ç®¡è¿›ç¨‹ï¼šå¯åŠ¨/åœæ­¢ CLIã€è°ƒ Adapterã€æ¨çŠ¶æ€ |
| 5 | AgentRegistry | ç®¡é…ç½®ï¼šå‘˜å·¥æ¡£æ¡ˆã€æŠ€èƒ½ã€Adapter æ˜ å°„ |
| 6 | API Gateway | ç®¡é€šä¿¡ï¼šREST + WebSocketï¼Œå‰åç«¯æ¡¥æ¢ |

---

## ä¸‰ã€Agent äº¤äº’åè®®ï¼ˆå…¨ç³»ç»Ÿçš„åŸºçŸ³ï¼‰

è¿™æ˜¯æœ€é‡è¦çš„ä¸€å±‚ã€‚æ‰€æœ‰ Agent æ— è®ºæ¥è‡ªå“ªé‡Œï¼Œåªè¦æ»¡è¶³è¿™å¥—åè®®å°±èƒ½æ¥å…¥ã€‚

### 3.1 ç³»ç»Ÿ â†’ Agent çš„å…¥å‚ï¼ˆAgentInputï¼‰

```python
class AgentInput(BaseModel):
    """ç³»ç»Ÿå‘ç»™ Agent çš„è¾“å…¥"""

    # èº«ä»½ä¸ä¼šè¯
    session_id: str                          # ç¾¤ç»„ä¼šè¯ ID
    turn_id: str                             # æœ¬è½®å›åˆ IDï¼ˆç”¨äºå»é‡å’Œæ’åºï¼‰
    agent_id: str                            # æœ¬å‘˜å·¥çš„ ID
    role_prompt: str                         # æœ¬å‘˜å·¥çš„è§’è‰²æè¿° / System Prompt

    # å“åº”è¦æ±‚
    invocation: Literal["must_reply", "may_reply"]
    mentioned_by: str | None = None          # è° @ äº†ä½ ï¼ˆagent_id æˆ– user_idï¼‰

    # æ¶ˆæ¯ä¸Šä¸‹æ–‡ï¼ˆå·²ç»è¿‡æˆªæ–­/æ‘˜è¦å¤„ç†ï¼‰
    messages: list[Message]
    # ç»“æ„å¦‚ä¸‹ï¼š
    # class Message:
    #     role: Literal["user", "assistant", "system"]
    #     author_id: str
    #     author_name: str
    #     content: str
    #     timestamp: datetime

    # è®°å¿†æ³¨å…¥ï¼ˆç”± ContextBuilder æŒ‰éœ€æ£€ç´¢ï¼‰
    memory_context: str | None = None

    # Token æ§åˆ¶
    max_output_tokens: int = 2000
    prefer_concise: bool = True              # æç¤º Agent ç®€æ´å›å¤
```

### 3.2 Agent â†’ ç³»ç»Ÿçš„å‡ºå‚ï¼ˆAgentOutputï¼‰

```python
class AgentOutput(BaseModel):
    """Agent è¿”å›ç»™ç³»ç»Ÿçš„è¾“å‡º"""

    # å¿…å¡«
    content: str                             # å›å¤çš„æ–‡æœ¬å†…å®¹

    # å¯é€‰ï¼šé“¾å¼è°ƒç”¨
    next_mentions: list[str] = []            # å¸Œæœ›ä¸‹ä¸€è½®å¼ºåˆ¶å›å¤çš„ agent_id åˆ—è¡¨
                                             # ç›¸å½“äº Agent åœ¨å›å¤ä¸­ @ äº†å…¶ä»–äºº

    # å¯é€‰ï¼šçŠ¶æ€ä¸ŠæŠ¥ï¼ˆç”¨äºå³ä¾§åŠ¨ç”»ï¼‰
    status_updates: list[StatusEvent] = []
    # class StatusEvent:
    #     status: Literal["analyzing", "reading_memory", "calling_tool",
    #                      "generating", "reviewing", "done", "error"]
    #     detail: str = ""                   # å¦‚ "æ­£åœ¨è°ƒç”¨ MCP å·¥å…·: file_search"
    #     progress: float | None = None      # 0.0 ~ 1.0

    # å¯é€‰ï¼šé™„ä»¶
    attachments: list[Attachment] = []
    # class Attachment:
    #     type: Literal["file", "code", "json", "image"]
    #     name: str
    #     data: str                          # base64 æˆ–æ–‡æœ¬å†…å®¹

    # å¯é€‰ï¼šè‡ªæˆ‘åˆ¤æ–­ï¼ˆä»… may_reply æ—¶æœ‰æ•ˆï¼‰
    should_respond: bool = True              # å¦‚æœ Agent åˆ¤æ–­è‡ªå·±ä¸éœ€è¦å›å¤ï¼Œè®¾ä¸º False
```

### 3.3 Adapter æ¥å£

æ¯ä¸ª CLI/API ä¸€ä¸ª Adapterï¼ŒèŒè´£ï¼šæŠŠ `AgentInput` è½¬æˆè¯¥ CLI çš„è°ƒç”¨æ–¹å¼ï¼ŒæŠŠè¾“å‡ºè§£ææˆ `AgentOutput`ã€‚

```python
class BaseAdapter(ABC):
    """æ‰€æœ‰ Adapter çš„åŸºç±»"""

    @abstractmethod
    async def invoke(self, input: AgentInput, stream_callback=None) -> AgentOutput:
        """
        è°ƒç”¨åº•å±‚ CLI/APIï¼Œè¿”å›ç»“æœã€‚
        stream_callback: å¯é€‰ï¼Œç”¨äºæµå¼è¾“å‡ºæ—¶é€æ­¥æ¨é€ç»™å‰ç«¯ã€‚
        """
        ...

    @abstractmethod
    async def health_check(self) -> bool:
        """æ£€æŸ¥åº•å±‚æœåŠ¡æ˜¯å¦å¯ç”¨"""
        ...

    @abstractmethod
    async def start(self, config: dict) -> None:
        """å¯åŠ¨åº•å±‚è¿›ç¨‹/è¿æ¥"""
        ...

    @abstractmethod
    async def stop(self) -> None:
        """åœæ­¢åº•å±‚è¿›ç¨‹/è¿æ¥"""
        ...
```

**å†…ç½® Adapter ç¤ºä¾‹ï¼š**

| Adapter | åº•å±‚ | è°ƒç”¨æ–¹å¼ |
|---------|------|---------|
| `ClaudeCliAdapter` | Claude Code CLI | `subprocess` ç®¡ç†è¿›ç¨‹ï¼Œstdin/stdout é€šä¿¡ |
| `CursorCliAdapter` | Cursor CLI | `subprocess`ï¼Œè§£æå…¶ç‰¹å®šè¾“å‡ºæ ¼å¼ |
| `OpenAIApiAdapter` | OpenAI API | `httpx` è°ƒç”¨ REST API |
| `AnthropicApiAdapter` | Anthropic API | `anthropic` SDK |
| `LocalModelAdapter` | Ollama / vLLM | æœ¬åœ° HTTP API |
| `GenericCliAdapter` | ä»»æ„ CLI | é…ç½®åŒ–ï¼šæŒ‡å®šå¯åŠ¨å‘½ä»¤ã€è¾“å…¥æ ¼å¼ã€è¾“å‡ºè§£æè§„åˆ™ |

**æ–°å¢ä¸€ä¸ª CLI åªéœ€è¦ï¼š** å†™ä¸€ä¸ªç»§æ‰¿ `BaseAdapter` çš„ç±» + åœ¨ AgentRegistry æ³¨å†Œã€‚

---

## å››ã€ç¼–æ’å¼•æ“ï¼ˆOrchestratorï¼‰â€”â€” ç³»ç»Ÿçš„å¤§è„‘

è¿™æ˜¯ç³»ç»Ÿæœ€æ ¸å¿ƒçš„æ¨¡å—ã€‚å®ƒå†³å®šã€Œè°åœ¨ä»€ä¹ˆæ—¶å€™ã€æ”¶åˆ°ä»€ä¹ˆè¾“å…¥ã€æ˜¯å¦å¿…é¡»å›å¤ã€ã€‚

### 4.1 å›åˆï¼ˆTurnï¼‰æ¨¡å‹

ä¸€æ¡æ¶ˆæ¯è§¦å‘ä¸€ä¸ªã€Œå›åˆã€ï¼Œä¸€ä¸ªå›åˆå†…å¯ä»¥æœ‰å¤šä¸ª Agent å›å¤ã€‚

```python
class Turn:
    turn_id: str
    trigger_message: Message            # è§¦å‘æœ¬å›åˆçš„æ¶ˆæ¯
    trigger_source: str                 # è°å‘çš„ï¼ˆuser_id æˆ– agent_idï¼‰

    must_reply_agents: list[str]        # æœ¬è½®å¿…é¡»å›å¤çš„ agent_id
    may_reply_agents: list[str]         # æœ¬è½®å¯ä»¥å›å¤çš„ agent_id
    completed_replies: list[AgentOutput]  # å·²æ”¶åˆ°çš„å›å¤

    max_responders: int = 5             # æœ¬è½®æœ€å¤šå‡ ä¸ª Agent å›å¤ï¼ˆé˜²åˆ·å±ï¼‰
    timeout_seconds: int = 120          # æœ¬è½®è¶…æ—¶æ—¶é—´
```

### 4.2 å“åº”å†³ç­–è§„åˆ™ï¼ˆæ ¸å¿ƒé€»è¾‘ï¼‰

å½“ä¸€æ¡æ–°æ¶ˆæ¯åˆ°è¾¾æ—¶ï¼ŒOrchestrator æ‰§è¡Œä»¥ä¸‹æµç¨‹ï¼š

```
æ–°æ¶ˆæ¯åˆ°è¾¾
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 1: è§£æ @mention       â”‚
â”‚                             â”‚
â”‚ â€¢ @å…·ä½“å‘˜å·¥ â†’ must_reply    â”‚
â”‚ â€¢ @æ‰€æœ‰äºº   â†’ å…¨å‘˜ must     â”‚
â”‚ â€¢ æ—  @      â†’ è§ Step 2    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 2: å¤„ç†é“¾å¼è°ƒç”¨         â”‚
â”‚                             â”‚
â”‚ å¦‚æœå‘é€æ–¹æ˜¯ Agent ä¸”è¿”å›äº† â”‚
â”‚ next_mentionsï¼Œå°†è¿™äº› Agent â”‚
â”‚ åŠ å…¥ must_reply             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 3: å…¶ä½™ Agent è¯„ä¼°     â”‚
â”‚                             â”‚
â”‚ ä¸åœ¨ must_reply ä¸­çš„ Agent  â”‚
â”‚ æ”¶åˆ° may_reply è¯·æ±‚ï¼Œè‡ªè¡Œ   â”‚
â”‚ åˆ¤æ–­æ˜¯å¦å›å¤ï¼ˆè¿”å›          â”‚
â”‚ should_respond = True/Falseï¼‰â”‚
â”‚                             â”‚
â”‚ è¯„ä¼°æ–¹å¼ï¼ˆäºŒé€‰ä¸€ï¼Œå¯é…ç½®ï¼‰ï¼š  â”‚
â”‚ A. å‘ç»™ Agent è®©å®ƒè‡ªå·±åˆ¤æ–­  â”‚
â”‚ B. ç³»ç»Ÿä¾§åšè½»é‡åŒ¹é…ï¼ˆå…³é”®  â”‚
â”‚    è¯ + è§’è‰²ç›¸å…³æ€§ï¼‰        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 4: ä¸¤é˜¶æ®µä¸²è¡Œæ‰§è¡Œ       â”‚
â”‚                             â”‚
â”‚ Phase A: must_replyï¼ˆå¹¶è¡Œï¼‰ â”‚
â”‚   â†’ å…¨éƒ¨å®Œæˆåï¼Œå›å¤å†™å…¥    â”‚
â”‚     æ¶ˆæ¯æµï¼Œæ¨å‰ç«¯           â”‚
â”‚                             â”‚
â”‚ Phase B: may_replyï¼ˆå¹¶è¡Œï¼‰  â”‚
â”‚   â†’ å¯ä»¥çœ‹åˆ° Phase A çš„å›å¤ â”‚
â”‚   â†’ å…¨éƒ¨å®Œæˆåï¼Œå›å¤å†™å…¥    â”‚
â”‚     æ¶ˆæ¯æµï¼Œæ¨å‰ç«¯           â”‚
â”‚                             â”‚
â”‚ æ€»æ•°ä¸è¶…è¿‡ max_responders   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 5: æ”¶é›† next_mentions  â”‚
â”‚         æ‰¹é‡å¼€å¯ä¸‹ä¸€ä¸ª Turn  â”‚
â”‚                             â”‚
â”‚ ç­‰æœ¬ Turn å…¨éƒ¨å›å¤å®Œæˆåï¼š  â”‚
â”‚ â€¢ æ±‡æ€»æ‰€æœ‰å›å¤ä¸­çš„           â”‚
â”‚   next_mentionsï¼Œå»é‡        â”‚
â”‚ â€¢ åˆå¹¶ä¸ºä¸‹ä¸€ä¸ª Turn çš„       â”‚
â”‚   must_reply åˆ—è¡¨            â”‚
â”‚ â€¢ ä¸æ˜¯æ¯æ¡å›å¤ç«‹åˆ»è§¦å‘æ–°     â”‚
â”‚   Turnï¼Œè€Œæ˜¯ã€Œæ”¶é½å†å¼€ã€    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.3 Turn å†…éƒ¨çš„æ‰§è¡Œæ¨¡å‹ï¼ˆå…³é”®ç»†èŠ‚ï¼‰

ä¸€ä¸ª Turn çš„å†…éƒ¨æ‰§è¡Œåˆ†ä¸º**ä¸¤ä¸ªé˜¶æ®µ**ï¼Œé˜¶æ®µä¹‹é—´ä¸²è¡Œï¼Œé˜¶æ®µå†…éƒ¨å¹¶è¡Œï¼š

```
Turn N
â”œâ”€â”€ Phase A: must_reply agentsï¼ˆå¹¶è¡Œè°ƒç”¨ï¼‰
â”‚   â”‚
â”‚   â”‚  æ¶æ„å¸ˆã€åˆè§„ åŒæ—¶æ”¶åˆ°æ¶ˆæ¯ï¼ŒåŒæ—¶å¼€å§‹ç”Ÿæˆå›å¤
â”‚   â”‚  å®ƒä»¬çœ‹åˆ°çš„ä¸Šä¸‹æ–‡æ˜¯ä¸€æ ·çš„ï¼ˆéƒ½æ˜¯åˆ° Turn N è§¦å‘æ¶ˆæ¯ä¸ºæ­¢çš„å†å²ï¼‰
â”‚   â”‚  å®ƒä»¬äº’ç›¸çœ‹ä¸åˆ°å¯¹æ–¹æœ¬è½®çš„å›å¤ï¼ˆå› ä¸ºæ˜¯åŒæ—¶æ‰§è¡Œçš„ï¼‰
â”‚   â”‚
â”‚   â”œâ”€ æ¶æ„å¸ˆå›å¤ â†’ å†™å…¥æ¶ˆæ¯æµ â†’ æ¨å‰ç«¯
â”‚   â”‚   next_mentions: [å¼€å‘]
â”‚   â”‚
â”‚   â””â”€ åˆè§„å›å¤ â†’ å†™å…¥æ¶ˆæ¯æµ â†’ æ¨å‰ç«¯
â”‚       next_mentions: [æµ‹è¯•]
â”‚
â”œâ”€â”€ Phase B: may_reply agentsï¼ˆå¹¶è¡Œè°ƒç”¨ï¼‰
â”‚   â”‚
â”‚   â”‚  å¼€å‘ï¼ˆè‡ªä¸»åˆ¤æ–­è¦å›å¤ï¼‰æ”¶åˆ°æ¶ˆæ¯
â”‚   â”‚  å®ƒèƒ½çœ‹åˆ° Phase A ä¸­æ¶æ„å¸ˆå’Œåˆè§„çš„å›å¤ï¼ˆå› ä¸º Phase A å·²å®Œæˆï¼‰
â”‚   â”‚  è¿™æ · may_reply çš„ Agent æ‹¥æœ‰æ›´å®Œæ•´çš„ä¿¡æ¯
â”‚   â”‚
â”‚   â””â”€ å¼€å‘å›å¤ â†’ å†™å…¥æ¶ˆæ¯æµ â†’ æ¨å‰ç«¯
â”‚       next_mentions: [æµ‹è¯•]
â”‚
â””â”€â”€ Turn N ç»“æŸ
    â”‚
    â”‚  æ±‡æ€»æ‰€æœ‰ next_mentions:
    â”‚  æ¶æ„å¸ˆ â†’ [å¼€å‘]
    â”‚  åˆè§„   â†’ [æµ‹è¯•]
    â”‚  å¼€å‘   â†’ [æµ‹è¯•]
    â”‚
    â”‚  å»é‡å: must_reply = [å¼€å‘, æµ‹è¯•]
    â”‚  ä½†æ˜¯ï¼å¼€å‘å·²ç»åœ¨ Turn N å›å¤è¿‡äº† â†’ ä»åˆ—è¡¨ä¸­ç§»é™¤
    â”‚  æœ€ç»ˆ: must_reply = [æµ‹è¯•]
    â”‚
    â–¼
Turn N+1
â”œâ”€â”€ Phase A: must_reply = [æµ‹è¯•]
â”‚   æµ‹è¯•èƒ½çœ‹åˆ° Turn N ä¸­æ‰€æœ‰äººçš„å›å¤ï¼ˆæ¶æ„å¸ˆ + åˆè§„ + å¼€å‘ï¼‰
â”‚   ...
```

**ä¸ºä»€ä¹ˆé€‰æ‹©ã€Œæ”¶é½å†å¼€ä¸‹ä¸€ Turnã€è€Œä¸æ˜¯ã€Œè¾¹æ”¶è¾¹å¼€ã€ï¼Ÿ**

| æ–¹æ¡ˆ | ä¼˜ç‚¹ | ç¼ºç‚¹ |
|------|------|------|
| **æ”¶é½å†å¼€ï¼ˆæ‰¹é‡ï¼Œæœ¬æ–¹æ¡ˆï¼‰** | ä¸‹ä¸€ Turn çš„ Agent èƒ½çœ‹åˆ°æœ¬ Turn å…¨éƒ¨å›å¤ï¼Œä¿¡æ¯å®Œæ•´ï¼›ä¸ä¼šäº§ç”Ÿç«æ€æ¡ä»¶ | å»¶è¿Ÿç•¥é«˜ï¼ˆè¦ç­‰æœ€æ…¢çš„ Agent å®Œæˆï¼‰ |
| è¾¹æ”¶è¾¹å¼€ï¼ˆæµå¼ï¼‰ | å»¶è¿Ÿä½ï¼Œæ¶æ„å¸ˆä¸€å›å¤å°±ç«‹åˆ»è§¦å‘å¼€å‘ | å¼€å‘çœ‹ä¸åˆ°åˆè§„çš„å›å¤ï¼›å¯èƒ½äº§ç”Ÿå¹¶å‘å†²çªï¼›é€»è¾‘å¤æ‚ |

**æ‰¹é‡æ¨¡å¼æ›´å®‰å…¨ã€æ›´å¯é¢„æµ‹**ï¼Œä¸” Agent å“åº”é€šå¸¸åœ¨ç§’çº§ï¼Œå¤šç­‰å‡ ç§’æ¢æ¥çš„æ˜¯ä¿¡æ¯å®Œæ•´æ€§ã€‚

### 4.4 ç‰¹æ®Šæƒ…å†µå¤„ç†

**æƒ…å†µ 1ï¼šå¤šä¸ª Agent @ äº†åŒä¸€ä¸ªäºº**
```
Turn N:
  æ¶æ„å¸ˆ next_mentions: [å¼€å‘]    "è¯·æŒ‰è¿™ä¸ªæ–¹æ¡ˆå®ç°"
  åˆè§„   next_mentions: [å¼€å‘]    "å®ç°æ—¶æ³¨æ„ä»¥ä¸‹åˆè§„è¦æ±‚"

Turn N+1:
  å¼€å‘æ”¶åˆ° must_reply
  å®ƒçš„æ¶ˆæ¯ä¸Šä¸‹æ–‡ä¸­åŒæ—¶åŒ…å«æ¶æ„å¸ˆå’Œåˆè§„çš„å›å¤
  å¼€å‘è‡ªå·±ç»¼åˆä¸¤è¾¹çš„è¦æ±‚æ¥å›å¤ï¼ˆè¿™å°±æ˜¯"æ”¶é½å†å¼€"çš„å¥½å¤„ï¼‰
```

**æƒ…å†µ 2ï¼šè¢« next_mention çš„äººå·²ç»åœ¨æœ¬ Turn å›å¤è¿‡äº†**
```
Turn N:
  æ¶æ„å¸ˆ must_reply â†’ å›å¤äº† â†’ next_mentions: [å¼€å‘]
  å¼€å‘   may_reply  â†’ ä¹Ÿå›å¤äº† â†’ next_mentions: [æµ‹è¯•]

å»é‡é€»è¾‘ï¼š
  æ±‡æ€» next_mentions = [å¼€å‘, æµ‹è¯•]
  å¼€å‘å·²ç»åœ¨ Turn N å›å¤è¿‡ â†’ ç§»é™¤
  æœ€ç»ˆ Turn N+1 çš„ must_reply = [æµ‹è¯•]
```

ä½†å¦‚æœæ¶æ„å¸ˆ @ å¼€å‘çš„å†…å®¹æ˜¯**æ–°çš„æŒ‡ä»¤**ï¼ˆä¸æ˜¯å¯¹ä¹‹å‰æ¶ˆæ¯çš„å›åº”ï¼‰ï¼Œå¼€å‘æ˜¯å¦éœ€è¦å†å›å¤ä¸€æ¬¡ï¼Ÿè¿™é‡Œæä¾›ä¸€ä¸ªå¯é…ç½®é¡¹ï¼š

```python
class TurnConfig:
    # å¦‚æœæŸ Agent å·²åœ¨æœ¬ Turn å›å¤è¿‡ï¼Œä½†è¢«å…¶ä»– Agent next_mention äº†ï¼Œ
    # æ˜¯å¦åœ¨ä¸‹ä¸€ Turn ä¸­å†æ¬¡è§¦å‘å®ƒï¼Ÿ
    re_invoke_already_replied: bool = False  # é»˜è®¤ä¸é‡å¤è§¦å‘
    # è®¾ä¸º True åˆ™å…è®¸åŒä¸€ä¸ª Agent åœ¨è¿ç»­ Turn ä¸­è¢«åå¤è°ƒç”¨
    # ï¼ˆé€‚åˆéœ€è¦å¤šè½®ç¡®è®¤çš„åœºæ™¯ï¼Œä½†éœ€é…åˆ chain_depth_limit ä½¿ç”¨ï¼‰
```

**æƒ…å†µ 3ï¼šmay_reply çš„ Agent ä¹Ÿå¸¦äº† next_mentions**
```
Turn N:
  æ¶æ„å¸ˆ must_reply â†’ next_mentions: [å¼€å‘]
  æµ‹è¯•   may_reply  â†’ next_mentions: [å¼€å‘, åˆè§„]

å¤„ç†æ–¹å¼ï¼šå®Œå…¨ä¸€æ ·ã€‚may_reply çš„ Agent å›å¤åŒæ ·å¯ä»¥ @ å…¶ä»–äººã€‚
æ±‡æ€» next_mentions æ—¶ä¸åŒºåˆ†æ¥æºæ˜¯ must è¿˜æ˜¯ mayã€‚
```

**æƒ…å†µ 4ï¼šæ²¡æœ‰ä»»ä½• Agent äº§ç”Ÿ next_mentions**
```
Turn N:
  æ¶æ„å¸ˆ must_reply â†’ next_mentions: []
  å¼€å‘   may_reply  â†’ next_mentions: []

â†’ æ²¡æœ‰æ–°çš„ must_reply
â†’ ä¸ä¼šäº§ç”Ÿ Turn N+1
â†’ ç­‰å¾…äººç±»å‘é€ä¸‹ä¸€æ¡æ¶ˆæ¯
```

### 4.5 æ‰§è¡Œä¼ªä»£ç 

æŠŠä»¥ä¸Šé€»è¾‘æ±‡æ€»æˆ Orchestrator çš„æ ¸å¿ƒæ–¹æ³•ï¼š

```python
class Orchestrator:
    async def execute_turn(self, turn: Turn, session_id: str):
        """æ‰§è¡Œä¸€ä¸ªå®Œæ•´çš„ Turn"""

        all_next_mentions: set[str] = set()
        replied_agents: set[str] = set()

        # â”€â”€ Phase A: must_replyï¼ˆå¹¶è¡Œï¼‰â”€â”€
        must_tasks = [
            self._invoke_one(agent_id, session_id, "must_reply", turn)
            for agent_id in turn.must_reply_agents
        ]
        must_outputs = await asyncio.gather(*must_tasks)

        for agent_id, output in zip(turn.must_reply_agents, must_outputs):
            await self.session_manager.save_message(output, turn.turn_id)
            await self.ws_manager.broadcast_message(output)
            all_next_mentions.update(output.next_mentions)
            replied_agents.add(agent_id)

        # â”€â”€ Phase B: may_replyï¼ˆå¹¶è¡Œï¼‰â”€â”€
        # may_reply çš„ Agent ç°åœ¨èƒ½çœ‹åˆ° Phase A çš„å›å¤äº†
        may_agents = [
            aid for aid in turn.may_reply_agents
            if aid not in replied_agents  # å·²ç»å›å¤è¿‡çš„ä¸å†é‡å¤
        ]
        may_tasks = [
            self._invoke_one(agent_id, session_id, "may_reply", turn)
            for agent_id in may_agents
        ]
        may_outputs = await asyncio.gather(*may_tasks)

        for agent_id, output in zip(may_agents, may_outputs):
            if output.should_respond:  # may_reply å¯ä»¥é€‰æ‹©ä¸å›å¤
                await self.session_manager.save_message(output, turn.turn_id)
                await self.ws_manager.broadcast_message(output)
                all_next_mentions.update(output.next_mentions)
                replied_agents.add(agent_id)

        # â”€â”€ å†³å®šæ˜¯å¦å¼€å¯ä¸‹ä¸€ä¸ª Turn â”€â”€
        # å»é‡ï¼šç§»é™¤æœ¬ Turn å·²å›å¤è¿‡çš„ Agentï¼ˆå¯é…ç½®ï¼‰
        if not self.config.re_invoke_already_replied:
            all_next_mentions -= replied_agents

        if all_next_mentions and turn.chain_depth < self.config.chain_depth_limit:
            next_turn = Turn(
                turn_id=generate_turn_id(),
                trigger_message=None,  # ä¸‹ä¸€ Turn çš„è§¦å‘ä¸æ˜¯å•æ¡æ¶ˆæ¯ï¼Œè€Œæ˜¯æœ¬ Turn çš„å…¨éƒ¨å›å¤
                must_reply_agents=list(all_next_mentions),
                may_reply_agents=self._evaluate_may_reply(session_id, all_next_mentions),
                chain_depth=turn.chain_depth + 1,
            )
            await self.execute_turn(next_turn, session_id)  # é€’å½’
        elif turn.chain_depth >= self.config.chain_depth_limit:
            # é“¾å¼æ·±åº¦è¾¾åˆ°ä¸Šé™ï¼Œé€šçŸ¥å‰ç«¯
            await self.ws_manager.broadcast_system_message(
                session_id,
                f"âš ï¸ è‡ªåŠ¨å¯¹è¯å·²è¾¾åˆ° {self.config.chain_depth_limit} è½®ä¸Šé™ï¼Œç­‰å¾…äººç±»æŒ‡ä»¤ã€‚"
            )
```

### 4.3 é˜²æŠ¤æœºåˆ¶ï¼ˆé˜²æ­¢æ··ä¹±ï¼‰

| é£é™© | é˜²æŠ¤æªæ–½ |
|------|---------|
| æ— é™å¾ªç¯ï¼ˆA @ B â†’ B @ A â†’ ...ï¼‰ | **é“¾å¼æ·±åº¦é™åˆ¶**ï¼šåŒä¸€ä¼šè¯å†…è¿ç»­è‡ªåŠ¨ Turn æœ€å¤š N å±‚ï¼ˆé»˜è®¤ 5ï¼‰ï¼Œè¶…è¿‡åˆ™æš‚åœå¹¶æç¤ºäººç±» |
| åŒæ—¶å›å¤å¤ªå¤š | **max_responders**ï¼šæ¯ä¸ª Turn æœ€å¤š N ä¸ª Agent å›å¤ |
| Agent å¡æ­» | **è¶…æ—¶æœºåˆ¶**ï¼šæ¯ä¸ª Agent å›å¤æœ‰æ—¶é™ï¼Œè¶…æ—¶åˆ™è·³è¿‡å¹¶æ ‡è®°çŠ¶æ€ä¸º timeout |
| é‡å¤å›å¤ | **Turn ID å»é‡**ï¼šåŒä¸€ Turn å†…æ¯ä¸ª Agent æœ€å¤šå›å¤ä¸€æ¬¡ |
| æˆæœ¬å¤±æ§ | **Token é¢„ç®—**ï¼šæ¯ä¸ª Turn / æ¯ä¸ªä¼šè¯æœ‰ Token ä¸Šé™ï¼Œè¶…é™åˆ™é™çº§æˆ–æš‚åœ |

### 4.4 å¯é€‰ï¼šSupervisor æ¨¡å¼

å¦‚æœä½ å¸Œæœ›æœ‰ä¸€ä¸ªã€Œè¶…çº§ç®¡ç†å‘˜ã€æ¥ç»Ÿä¸€å†³å®šè°å›å¤ï¼Œå¯ä»¥å¯ç”¨ Supervisor æ¨¡å¼ï¼š

```python
# Supervisor ä¹Ÿæ˜¯ä¸€ä¸ª Agentï¼Œåªæ˜¯å®ƒçš„èŒè´£æ˜¯åšè·¯ç”±å†³ç­–
class SupervisorConfig:
    enabled: bool = False
    agent_id: str = "supervisor"
    # Supervisor æ”¶åˆ°æ¶ˆæ¯åï¼Œè¾“å‡ºç»“æ„åŒ–å†³ç­–ï¼š
    # { "should_reply": ["agent_A", "agent_B"], "reason": "..." }
    # ç³»ç»Ÿæ®æ­¤è®¾ç½® must_reply
```

Supervisor æ¨¡å¼é€‚ç”¨äºï¼šä»»åŠ¡æµç¨‹å›ºå®šã€éœ€è¦ä¸¥æ ¼æ§åˆ¶è°å¹²ä»€ä¹ˆçš„åœºæ™¯ã€‚
è‡ªç”±æ¨¡å¼é€‚ç”¨äºï¼šå¼€æ”¾è®¨è®ºã€å¤´è„‘é£æš´ã€çµæ´»åä½œçš„åœºæ™¯ã€‚
ä¸¤ç§æ¨¡å¼å¯ä»¥æŒ‰ç¾¤ç»„é…ç½®ï¼Œç”šè‡³å¯ä»¥æ··ç”¨ã€‚

---

## äº”ã€ä¼šè¯ç®¡ç†å™¨ï¼ˆSessionManagerï¼‰

çº¯æ•°æ®å±‚ï¼Œä¸åŒ…å«ä¸šåŠ¡é€»è¾‘ã€‚

### 5.1 æ•°æ®æ¨¡å‹

```python
class Group:
    """ç¾¤ç»„"""
    id: str
    name: str
    description: str
    created_at: datetime
    members: list[GroupMember]        # äººç±» + AI å‘˜å·¥
    config: GroupConfig              # ç¾¤ç»„çº§é…ç½®ï¼ˆå¦‚ max_respondersã€supervisor ç­‰ï¼‰

class GroupMember:
    """ç¾¤ç»„æˆå‘˜"""
    id: str
    type: Literal["human", "agent"]
    agent_id: str | None             # å¦‚æœæ˜¯ AI å‘˜å·¥ï¼Œå…³è”åˆ° AgentRegistry
    joined_at: datetime
    role_in_group: str | None        # åœ¨æœ¬ç¾¤ç»„ä¸­çš„è§’è‰²ï¼ˆå¯è¦†ç›–é»˜è®¤è§’è‰²ï¼‰

class Message:
    """æ¶ˆæ¯"""
    id: str
    group_id: str
    turn_id: str
    author_id: str
    author_type: Literal["human", "agent", "system"]
    author_name: str
    content: str
    mentions: list[str]              # è¢« @ çš„æˆå‘˜ ID åˆ—è¡¨
    attachments: list[Attachment]
    timestamp: datetime
    metadata: dict                   # æ‰©å±•å­—æ®µï¼ˆå¦‚ status_updatesã€next_mentions ç­‰ï¼‰
```

### 5.2 å­˜å‚¨é€‰æ‹©

**MVP é˜¶æ®µ**ï¼šSQLite â€”â€” é›¶é…ç½®ã€å•æ–‡ä»¶ã€å¤Ÿç”¨åˆ°å‡ åä¸‡æ¡æ¶ˆæ¯ã€‚
**åæœŸ**ï¼šå¯è¿ç§»åˆ° PostgreSQLï¼ŒSchema ä¸å˜ã€‚

```
data/
â”œâ”€â”€ agent_arena.db          # SQLite ä¸»æ•°æ®åº“ï¼ˆç¾¤ç»„ã€æ¶ˆæ¯ã€æˆå‘˜ï¼‰
â”œâ”€â”€ memory/                 # è®°å¿†å¿«ç…§ï¼ˆJSON æ–‡ä»¶ï¼‰
â”‚   â”œâ”€â”€ session_{id}.json
â”‚   â””â”€â”€ summary_{id}.json
â””â”€â”€ attachments/            # é™„ä»¶æ–‡ä»¶å­˜å‚¨
    â””â”€â”€ {message_id}/
```

---

## å…­ã€ä¸Šä¸‹æ–‡æ„å»ºå™¨ï¼ˆContextBuilderï¼‰

**èŒè´£**ï¼šä¸ºæ¯ä¸ªè¢«å”¤é†’çš„ Agent ç»„è£…å®ƒçš„ `AgentInput`ï¼Œæ ¸å¿ƒæ˜¯æ§åˆ¶ã€Œå®ƒèƒ½çœ‹åˆ°ä»€ä¹ˆã€ä»¥åŠã€ŒèŠ±å¤šå°‘ Tokenã€ã€‚

### 6.1 ä¸Šä¸‹æ–‡ç»„è£…æµç¨‹

```python
class ContextBuilder:
    async def build_input(
        self,
        agent_id: str,
        session_id: str,
        trigger_message: Message,
        invocation: Literal["must_reply", "may_reply"],
        mentioned_by: str | None,
    ) -> AgentInput:
        # 1. è·å–å‘˜å·¥ Profile
        profile = self.registry.get_agent(agent_id)

        # 2. è·å–æ¶ˆæ¯å†å²ï¼ˆå¸¦æˆªæ–­ï¼‰
        messages = await self.get_truncated_history(
            session_id,
            max_tokens=profile.context_window - profile.reserved_output_tokens
        )

        # 3. æ£€ç´¢ç›¸å…³è®°å¿†ï¼ˆæŒ‰éœ€ï¼‰
        memory = await self.retrieve_memory(session_id, trigger_message.content)

        # 4. ç»„è£… AgentInput
        return AgentInput(
            session_id=session_id,
            turn_id=generate_turn_id(),
            agent_id=agent_id,
            role_prompt=profile.role_prompt,
            invocation=invocation,
            mentioned_by=mentioned_by,
            messages=messages,
            memory_context=memory,
            max_output_tokens=profile.max_output_tokens,
            prefer_concise=True,
        )
```

### 6.2 Token èŠ‚çœç­–ç•¥ï¼ˆå››å±‚ï¼‰

```
Layer 1: æ¶ˆæ¯æˆªæ–­
    â”‚  åªä¿ç•™æœ€è¿‘ N æ¡æ¶ˆæ¯ï¼Œæˆ–æœ€è¿‘ N tokens
    â”‚  é‡è¦æ¶ˆæ¯ï¼ˆè¢«æ ‡è®°çš„å†³ç­–ã€éœ€æ±‚ï¼‰æ°¸è¿œä¿ç•™
    â–¼
Layer 2: å†å²æ‘˜è¦
    â”‚  å½“æ¶ˆæ¯è¶…è¿‡é˜ˆå€¼æ—¶ï¼Œå°†æ—§æ¶ˆæ¯å‹ç¼©æˆæ‘˜è¦
    â”‚  æ‘˜è¦å¯ä»¥ç”¨è½»é‡æ¨¡å‹ç”Ÿæˆï¼ˆå¦‚ Haiku / GPT-4o-miniï¼‰
    â”‚  æ‘˜è¦æ›¿æ¢åŸå§‹æ¶ˆæ¯ï¼Œå¤§å¹…å‡å°‘ Token
    â–¼
Layer 3: è®°å¿†æ£€ç´¢
    â”‚  ä¸æ˜¯æŠŠæ‰€æœ‰è®°å¿†éƒ½å¡è¿›å»ï¼Œè€Œæ˜¯æŒ‰å½“å‰æ¶ˆæ¯çš„è¯­ä¹‰
    â”‚  æ£€ç´¢æœ€ç›¸å…³çš„ Top-K æ¡è®°å¿†ç‰‡æ®µ
    â”‚  å¯ç”¨ç®€å•çš„ TF-IDFï¼Œä¹Ÿå¯ä»¥ç”¨å‘é‡æ£€ç´¢
    â–¼
Layer 4: ç®€æ´å›å¤å¼•å¯¼
    â”‚  åœ¨ role_prompt ä¸­åŠ å…¥ "è¯·ç®€æ´å›å¤" çš„æŒ‡ä»¤
    â”‚  è®¾ç½® max_output_tokens é™åˆ¶è¾“å‡ºé•¿åº¦
    â”‚  å‰ç«¯å¯ä»¥å±•ç¤º "å±•å¼€è¯¦æƒ…" è®©ç”¨æˆ·æŒ‰éœ€æŸ¥çœ‹
```

### 6.3 è®°å¿†ç³»ç»Ÿè®¾è®¡

**æ ¸å¿ƒå†³ç­–ï¼šè®°å¿†æŒ‰ç¾¤ç»„ä¼šè¯å­˜å‚¨ï¼Œä¸æŒ‰å‘˜å·¥åˆ‡åˆ†ã€‚**

ç†ç”±ï¼š
- åŒä¸€ä¸ªç¾¤ç»„å†…çš„å‘˜å·¥éœ€è¦çœ‹åˆ°ç›¸åŒçš„é¡¹ç›®ä¸Šä¸‹æ–‡
- å‘˜å·¥æ˜¯æ— çŠ¶æ€çš„ï¼Œå®ƒçš„ã€Œè®°å¿†ã€ç”±ç³»ç»Ÿåœ¨è°ƒç”¨æ—¶æ³¨å…¥
- å¤§å¹…ç®€åŒ–å­˜å‚¨å’Œç®¡ç†é€»è¾‘

```python
class MemoryStore:
    """ä¼šè¯è®°å¿†å­˜å‚¨"""

    async def save_memory(self, session_id: str, memory: MemoryEntry):
        """ä¿å­˜ä¸€æ¡è®°å¿†"""
        ...

    async def search_memory(
        self, session_id: str, query: str, top_k: int = 5
    ) -> list[MemoryEntry]:
        """æŒ‰è¯­ä¹‰æ£€ç´¢ç›¸å…³è®°å¿†"""
        ...

    async def generate_summary(self, session_id: str) -> str:
        """ç”Ÿæˆå½“å‰ä¼šè¯çš„æ‘˜è¦"""
        ...

class MemoryEntry:
    id: str
    session_id: str
    content: str                     # è®°å¿†å†…å®¹
    memory_type: Literal[
        "decision",                  # å…³é”®å†³ç­–
        "requirement",               # éœ€æ±‚å®šä¹‰
        "task",                      # ä»»åŠ¡åˆ†é…
        "issue",                     # é—®é¢˜/Bug
        "summary",                   # é˜¶æ®µæ‘˜è¦
    ]
    importance: float                # 0.0 ~ 1.0ï¼Œå†³å®šæ˜¯å¦åœ¨æˆªæ–­æ—¶ä¿ç•™
    created_at: datetime
    source_message_id: str           # å…³è”çš„åŸå§‹æ¶ˆæ¯
```

**ä»€ä¹ˆæ—¶å€™å†™å…¥è®°å¿†ï¼Ÿ**
- ä¸æ˜¯æ¯æ¡æ¶ˆæ¯éƒ½å†™ã€‚ç”± ContextBuilder åˆ¤æ–­å“ªäº›æ¶ˆæ¯å€¼å¾—è®°å¿†ï¼ˆå¦‚åŒ…å«å†³ç­–ã€éœ€æ±‚å˜æ›´ã€ä»»åŠ¡åˆ†é…ç­‰å…³é”®ä¿¡æ¯ï¼‰ã€‚
- ä¹Ÿå¯ä»¥åšæˆåå°å®šæ—¶ä»»åŠ¡ï¼šæ¯éš” N æ¡æ¶ˆæ¯ï¼Œç”¨è½»é‡æ¨¡å‹æå–å…³é”®ä¿¡æ¯å­˜å…¥è®°å¿†ã€‚

---

## ä¸ƒã€å‘˜å·¥è¿è¡Œæ—¶ï¼ˆWorkerRuntimeï¼‰

**èŒè´£**ï¼šç®¡ç†æ¯ä¸ª Agent çš„åº•å±‚è¿›ç¨‹/è¿æ¥ï¼Œæ‰§è¡Œ Adapter è°ƒç”¨ï¼Œä¸ŠæŠ¥çŠ¶æ€ã€‚

### 7.1 è¿›ç¨‹ç”Ÿå‘½å‘¨æœŸ

```python
class WorkerRuntime:
    """ç®¡ç†æ‰€æœ‰æ´»è·ƒçš„ Agent è¿›ç¨‹"""

    workers: dict[str, WorkerProcess]  # agent_id â†’ WorkerProcess

    async def ensure_worker(self, agent_id: str) -> WorkerProcess:
        """ç¡®ä¿æŸä¸ª Agent çš„åº•å±‚è¿›ç¨‹å·²å¯åŠ¨"""
        if agent_id not in self.workers:
            profile = self.registry.get_agent(agent_id)
            adapter = self.create_adapter(profile.adapter_type, profile.adapter_config)
            await adapter.start(profile.adapter_config)
            self.workers[agent_id] = WorkerProcess(
                agent_id=agent_id,
                adapter=adapter,
                status="idle",
            )
        return self.workers[agent_id]

    async def invoke_agent(
        self, agent_id: str, input: AgentInput, stream_callback=None
    ) -> AgentOutput:
        """è°ƒç”¨ä¸€ä¸ª Agentï¼Œè¿”å›ç»“æœ"""
        worker = await self.ensure_worker(agent_id)
        worker.status = "busy"
        try:
            # ä¸ŠæŠ¥çŠ¶æ€ï¼šå¼€å§‹å¤„ç†
            await self.emit_status(agent_id, "analyzing", "æ­£åœ¨åˆ†ææ¶ˆæ¯...")

            output = await worker.adapter.invoke(input, stream_callback)

            # ä¸ŠæŠ¥çŠ¶æ€ï¼šå®Œæˆ
            await self.emit_status(agent_id, "done")
            return output
        except TimeoutError:
            await self.emit_status(agent_id, "error", "å“åº”è¶…æ—¶")
            raise
        finally:
            worker.status = "idle"

    async def emit_status(self, agent_id: str, status: str, detail: str = ""):
        """é€šè¿‡ WebSocket æ¨é€çŠ¶æ€ç»™å‰ç«¯"""
        await self.ws_manager.broadcast({
            "type": "agent_status",
            "agent_id": agent_id,
            "status": status,
            "detail": detail,
            "timestamp": now(),
        })
```

### 7.2 çŠ¶æ€äº‹ä»¶ï¼ˆé©±åŠ¨å³ä¾§åŠ¨ç”»ï¼‰

é¢„å®šä¹‰çš„çŠ¶æ€ç±»å‹ï¼Œå‰ç«¯æ®æ­¤æ˜¾ç¤ºä¸åŒåŠ¨ç”»ï¼š

| status | å«ä¹‰ | å‰ç«¯åŠ¨ç”»å»ºè®® |
|--------|------|-------------|
| `idle` | ç©ºé—² | ç°è‰²å¤´åƒï¼Œé™æ­¢ |
| `analyzing` | æ­£åœ¨åˆ†ææ¶ˆæ¯ | è“è‰²å‘¼å¸ç¯ |
| `reading_memory` | æ­£åœ¨è¯»å–è®°å¿† | ç¿»ä¹¦å›¾æ ‡ |
| `calling_tool` | æ­£åœ¨è°ƒç”¨å·¥å…·/MCP | é½¿è½®è½¬åŠ¨ |
| `generating` | æ­£åœ¨ç”Ÿæˆå›å¤ | æ‰“å­—åŠ¨ç”»ï¼ˆä¸‰ä¸ªç‚¹ï¼‰ |
| `reviewing` | æ­£åœ¨å®¡æŸ¥/æ£€éªŒ | æ”¾å¤§é•œå›¾æ ‡ |
| `waiting` | ç­‰å¾…å…¶ä»– Agent | æ²™æ¼å›¾æ ‡ |
| `done` | å®Œæˆ | ç»¿è‰²å¯¹å‹¾ï¼Œé—ªä¸€ä¸‹ |
| `error` | å‡ºé”™ | çº¢è‰²æ„Ÿå¹å· |
| `timeout` | è¶…æ—¶ | é»„è‰²è­¦å‘Š |

---

## å…«ã€å‘˜å·¥ä¸æŠ€èƒ½æ³¨å†Œè¡¨ï¼ˆAgentRegistryï¼‰

### 8.1 å‘˜å·¥ Profile

```yaml
# agents/architect.yaml
agent_id: "architect"
name: "æ¶æ„å¸ˆ"
avatar: "ğŸ—ï¸"

# è§’è‰²æè¿°ï¼ˆä¼šä½œä¸º System Prompt æ³¨å…¥ï¼‰
role_prompt: |
  ä½ æ˜¯ä¸€ä½èµ„æ·±è½¯ä»¶æ¶æ„å¸ˆã€‚ä½ çš„èŒè´£æ˜¯ï¼š
  1. åˆ†æç”¨æˆ·éœ€æ±‚ï¼Œæ‹†è§£æˆå…·ä½“çš„æŠ€æœ¯ä»»åŠ¡
  2. è®¾è®¡ç³»ç»Ÿæ¶æ„å’ŒæŠ€æœ¯æ–¹æ¡ˆ
  3. è¯„ä¼°æŠ€æœ¯é€‰å‹å’Œå¯è¡Œæ€§
  å›å¤è¦æ±‚ï¼šç®€æ´ã€ç»“æ„åŒ–ã€ç”¨åˆ—è¡¨å’Œä»£ç å—ã€‚

# æŠ€èƒ½æ ‡ç­¾ï¼ˆç”¨äº Orchestrator åšç›¸å…³æ€§åŒ¹é…ï¼‰
skills:
  - "éœ€æ±‚åˆ†æ"
  - "æ¶æ„è®¾è®¡"
  - "ä»»åŠ¡æ‹†è§£"
  - "æŠ€æœ¯é€‰å‹"

# å“åº”é…ç½®
response_config:
  auto_respond: true                  # æ˜¯å¦å‚ä¸ may_reply è‡ªä¸»åˆ¤æ–­
  response_threshold: 0.6            # ç›¸å…³æ€§é˜ˆå€¼ï¼ˆ0~1ï¼‰ï¼Œè¶Šä½è¶Šå®¹æ˜“è§¦å‘
  priority_keywords: ["æ¶æ„", "è®¾è®¡", "æ–¹æ¡ˆ", "æŠ€æœ¯é€‰å‹", "æ‹†è§£"]

# Adapter é…ç½®
adapter_type: "anthropic_api"         # ä½¿ç”¨å“ªä¸ª Adapter
adapter_config:
  model: "claude-sonnet-4-5-20250929"
  max_tokens: 4096

# Token é…ç½®
context_window: 32000                 # ä¸Šä¸‹æ–‡çª—å£å¤§å°
max_output_tokens: 2000              # æœ€å¤§è¾“å‡º Token
reserved_output_tokens: 2000         # ä¸ºè¾“å‡ºé¢„ç•™çš„ Token
```

### 8.2 æ³¨å†Œè¡¨ç®¡ç†

```python
class AgentRegistry:
    """å‘˜å·¥ä¸æŠ€èƒ½æ³¨å†Œè¡¨"""

    def __init__(self, config_dir: str = "agents/"):
        self.agents: dict[str, AgentProfile] = {}
        self._load_from_dir(config_dir)

    def _load_from_dir(self, config_dir: str):
        """ä» YAML æ–‡ä»¶æ‰¹é‡åŠ è½½å‘˜å·¥é…ç½®"""
        for file in Path(config_dir).glob("*.yaml"):
            profile = AgentProfile.from_yaml(file)
            self.agents[profile.agent_id] = profile

    def get_agent(self, agent_id: str) -> AgentProfile:
        return self.agents[agent_id]

    def list_agents(self) -> list[AgentProfile]:
        return list(self.agents.values())

    def find_by_skill(self, keyword: str) -> list[AgentProfile]:
        """æŒ‰æŠ€èƒ½å…³é”®è¯æŸ¥æ‰¾åŒ¹é…çš„å‘˜å·¥"""
        return [
            a for a in self.agents.values()
            if any(keyword in s for s in a.skills)
        ]
```

**æ‰©å±•æ–°å‘˜å·¥**ï¼šåªéœ€åœ¨ `agents/` ç›®å½•ä¸‹æ–°å¢ä¸€ä¸ª YAML æ–‡ä»¶ï¼Œç³»ç»Ÿè‡ªåŠ¨åŠ è½½ã€‚

---

## ä¹ã€å®Œæ•´æ¶ˆæ¯æµï¼ˆç«¯åˆ°ç«¯ç¤ºä¾‹ï¼‰

ä»¥ä¸€ä¸ªæ›´å¤æ‚çš„åœºæ™¯ä¸ºä¾‹ï¼šäººç±» @æ¶æ„å¸ˆ å’Œ @åˆè§„ï¼ŒåŒæ—¶å¼€å‘è‡ªä¸»åˆ¤æ–­ä¹Ÿæƒ³å›å¤ã€‚

### 9.1 åˆå§‹æ¶ˆæ¯

```
äººç±»: "@æ¶æ„å¸ˆ @åˆè§„ è¯·å¸®æˆ‘æ‹†è§£è¿™ä¸ªéœ€æ±‚ï¼šåšä¸€ä¸ªç”¨æˆ·ç®¡ç†ç³»ç»Ÿï¼Œéœ€è¦ç¬¦åˆ GDPR"
```

### 9.2 Turn 1 çš„å®Œæ•´æ‰§è¡Œè¿‡ç¨‹

```
1. å‰ç«¯ â†’ API Gatewayï¼ˆWebSocketï¼‰
   â”‚  æ¶ˆæ¯å†…å®¹: "è¯·å¸®æˆ‘æ‹†è§£è¿™ä¸ªéœ€æ±‚..."
   â”‚  mentions: ["architect", "compliance"]
   â”‚
2. API Gateway â†’ SessionManager.save_message()
   â”‚
3. API Gateway â†’ Orchestrator.on_new_message()
   â”‚
4. Orchestrator åˆ›å»º Turn 1 (chain_depth=0)
   â”‚  è§£æ mentions â†’ must_reply: [architect, compliance]
   â”‚  å…¶ä½™ç¾¤ç»„æˆå‘˜ â†’ may_reply: [developer, tester]
   â”‚
   â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
   â•‘  Turn 1 Â· Phase A: must_replyï¼ˆå¹¶è¡Œï¼‰                    â•‘
   â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
   â•‘                                                          â•‘
   â•‘  æ¶æ„å¸ˆ å’Œ åˆè§„ åŒæ—¶è¢«è°ƒç”¨ï¼ˆasyncio.gatherï¼‰              â•‘
   â•‘  å®ƒä»¬çœ‹åˆ°çš„æ¶ˆæ¯å†å²ç›¸åŒï¼šæˆªæ­¢åˆ°äººç±»è¿™æ¡æ¶ˆæ¯ä¸ºæ­¢           â•‘
   â•‘  å®ƒä»¬äº’ç›¸çœ‹ä¸åˆ°å¯¹æ–¹åœ¨æœ¬ Turn çš„å›å¤                       â•‘
   â•‘                                                          â•‘
   â•‘  â”Œâ”€ æ¶æ„å¸ˆï¼ˆå¹¶è¡Œçº¿ç¨‹ 1ï¼‰â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â•‘
   â•‘  â”‚  ContextBuilder ç»„è£… AgentInput                   â”‚    â•‘
   â•‘  â”‚  â†’ messages: [...å†å², äººç±»æ¶ˆæ¯]                   â”‚    â•‘
   â•‘  â”‚  â†’ invocation: "must_reply"                       â”‚    â•‘
   â•‘  â”‚                                                    â”‚    â•‘
   â•‘  â”‚  WorkerRuntime.invoke_agent("architect")           â”‚    â•‘
   â•‘  â”‚  â†’ emit_status("analyzing")                       â”‚    â•‘
   â•‘  â”‚  â†’ emit_status("generating")                      â”‚    â•‘
   â•‘  â”‚  â†’ å›å¤å®Œæˆ                                        â”‚    â•‘
   â•‘  â”‚                                                    â”‚    â•‘
   â•‘  â”‚  AgentOutput:                                      â”‚    â•‘
   â•‘  â”‚    content: "éœ€æ±‚æ‹†è§£å¦‚ä¸‹ï¼š                         â”‚    â•‘
   â•‘  â”‚      1. ç”¨æˆ·è®¤è¯æ¨¡å—                                â”‚    â•‘
   â•‘  â”‚      2. æƒé™ç®¡ç†æ¨¡å—                                â”‚    â•‘
   â•‘  â”‚      3. æ•°æ®åŠ å¯†æ¨¡å—                                â”‚    â•‘
   â•‘  â”‚      @å…¨æ ˆå¼€å‘ è¯·æŒ‰æ­¤æ–¹æ¡ˆå®ç°"                      â”‚    â•‘
   â•‘  â”‚    next_mentions: ["developer"]                    â”‚    â•‘
   â•‘  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â•‘
   â•‘                                                          â•‘
   â•‘  â”Œâ”€ åˆè§„ï¼ˆå¹¶è¡Œçº¿ç¨‹ 2ï¼‰â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â•‘
   â•‘  â”‚  ContextBuilder ç»„è£… AgentInput                   â”‚    â•‘
   â•‘  â”‚  â†’ messages: [...å†å², äººç±»æ¶ˆæ¯]ï¼ˆå’Œæ¶æ„å¸ˆçœ‹åˆ°ä¸€æ ·ï¼‰â”‚    â•‘
   â•‘  â”‚  â†’ invocation: "must_reply"                       â”‚    â•‘
   â•‘  â”‚                                                    â”‚    â•‘
   â•‘  â”‚  AgentOutput:                                      â”‚    â•‘
   â•‘  â”‚    content: "GDPR åˆè§„è¦æ±‚ï¼š                        â”‚    â•‘
   â•‘  â”‚      1. éœ€è¦ç”¨æˆ·åŒæ„æœºåˆ¶                            â”‚    â•‘
   â•‘  â”‚      2. æ•°æ®å¯åˆ é™¤ ...                              â”‚    â•‘
   â•‘  â”‚      @æµ‹è¯•å·¥ç¨‹å¸ˆ è¯·å‡†å¤‡åˆè§„æµ‹è¯•ç”¨ä¾‹"                â”‚    â•‘
   â•‘  â”‚    next_mentions: ["tester"]                       â”‚    â•‘
   â•‘  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â•‘
   â•‘                                                          â•‘
   â•‘  Phase A å®Œæˆ â†’                                          â•‘
   â•‘    æ¶æ„å¸ˆçš„å›å¤å†™å…¥æ¶ˆæ¯æµï¼Œæ¨å‰ç«¯                          â•‘
   â•‘    åˆè§„çš„å›å¤å†™å…¥æ¶ˆæ¯æµï¼Œæ¨å‰ç«¯                            â•‘
   â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   â”‚
   â”‚  æ­¤æ—¶æ¶ˆæ¯æµçŠ¶æ€ï¼š
   â”‚  [äººç±»æ¶ˆæ¯] â†’ [æ¶æ„å¸ˆå›å¤] â†’ [åˆè§„å›å¤]
   â”‚
   â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
   â•‘  Turn 1 Â· Phase B: may_replyï¼ˆå¹¶è¡Œï¼‰                     â•‘
   â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
   â•‘                                                          â•‘
   â•‘  developer å’Œ tester è¢«è¯„ä¼°æ˜¯å¦è‡ªä¸»å›å¤                   â•‘
   â•‘  æ³¨æ„ï¼šå®ƒä»¬èƒ½çœ‹åˆ° Phase A çš„å›å¤ï¼                        â•‘
   â•‘                                                          â•‘
   â•‘  â”Œâ”€ å¼€å‘ï¼ˆmay_replyï¼‰â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â•‘
   â•‘  â”‚  ContextBuilder ç»„è£… AgentInput                   â”‚    â•‘
   â•‘  â”‚  â†’ messages: [...å†å², äººç±»æ¶ˆæ¯, æ¶æ„å¸ˆå›å¤, åˆè§„å›å¤] â”‚
   â•‘  â”‚  â†’ invocation: "may_reply"                        â”‚    â•‘
   â•‘  â”‚                                                    â”‚    â•‘
   â•‘  â”‚  å¼€å‘çœ‹åˆ°æ¶æ„å¸ˆçš„æ–¹æ¡ˆ + åˆè§„è¦æ±‚                     â”‚    â•‘
   â•‘  â”‚  â†’ åˆ¤æ–­ should_respond = True                      â”‚    â•‘
   â•‘  â”‚                                                    â”‚    â•‘
   â•‘  â”‚  AgentOutput:                                      â”‚    â•‘
   â•‘  â”‚    content: "æ”¶åˆ°ï¼Œæˆ‘å…ˆå®ç°ç”¨æˆ·è®¤è¯æ¨¡å—ï¼Œ             â”‚    â•‘
   â•‘  â”‚      ä¼šæŒ‰ç…§åˆè§„è¦æ±‚åŠ å…¥åŒæ„æœºåˆ¶ã€‚                     â”‚    â•‘
   â•‘  â”‚      @æµ‹è¯•å·¥ç¨‹å¸ˆ è®¤è¯æ¨¡å—å®Œæˆåè¯·åšå†’çƒŸæµ‹è¯•"         â”‚    â•‘
   â•‘  â”‚    next_mentions: ["tester"]                       â”‚    â•‘
   â•‘  â”‚    should_respond: true                            â”‚    â•‘
   â•‘  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â•‘
   â•‘                                                          â•‘
   â•‘  â”Œâ”€ æµ‹è¯•ï¼ˆmay_replyï¼‰â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â•‘
   â•‘  â”‚  ContextBuilder ç»„è£… AgentInput                   â”‚    â•‘
   â•‘  â”‚  â†’ çœ‹åˆ°äº†æ‰€æœ‰äººçš„å›å¤                              â”‚    â•‘
   â•‘  â”‚  â†’ å…³é”®è¯åŒ¹é… "æµ‹è¯•" ç›¸å…³æ€§ 0.4 < é˜ˆå€¼ 0.8        â”‚    â•‘
   â•‘  â”‚  â†’ should_respond = Falseï¼ˆæ²¡è¢« @ ä¸”ç›¸å…³æ€§ä¸å¤Ÿï¼‰   â”‚    â•‘
   â•‘  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â•‘
   â•‘                                                          â•‘
   â•‘  Phase B å®Œæˆ â†’                                          â•‘
   â•‘    å¼€å‘çš„å›å¤å†™å…¥æ¶ˆæ¯æµï¼Œæ¨å‰ç«¯                            â•‘
   â•‘    æµ‹è¯•æ²¡æœ‰å›å¤                                           â•‘
   â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   â”‚
   â”‚  Turn 1 å…¨éƒ¨å®Œæˆï¼Œæ¶ˆæ¯æµçŠ¶æ€ï¼š
   â”‚  [äººç±»æ¶ˆæ¯] â†’ [æ¶æ„å¸ˆå›å¤] â†’ [åˆè§„å›å¤] â†’ [å¼€å‘å›å¤]
   â”‚
5. æ±‡æ€» next_mentions
   â”‚  æ¶æ„å¸ˆ â†’ ["developer"]
   â”‚  åˆè§„   â†’ ["tester"]
   â”‚  å¼€å‘   â†’ ["tester"]
   â”‚
   â”‚  åˆå¹¶å»é‡: ["developer", "tester"]
   â”‚  å¼€å‘å·²åœ¨ Turn 1 å›å¤è¿‡ â†’ ç§»é™¤
   â”‚  æœ€ç»ˆ Turn 2 çš„ must_reply: ["tester"]
   â”‚
6. åˆ›å»º Turn 2 (chain_depth=1)
   â”‚
   â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
   â•‘  Turn 2 Â· Phase A: must_reply                            â•‘
   â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
   â•‘                                                          â•‘
   â•‘  â”Œâ”€ æµ‹è¯•å·¥ç¨‹å¸ˆï¼ˆmust_replyï¼‰â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â•‘
   â•‘  â”‚  ContextBuilder ç»„è£… AgentInput                   â”‚    â•‘
   â•‘  â”‚  â†’ messages åŒ…å« Turn 1 æ‰€æœ‰äººçš„å›å¤               â”‚    â•‘
   â•‘  â”‚  â†’ æµ‹è¯•èƒ½çœ‹åˆ°ï¼šæ¶æ„å¸ˆçš„æ–¹æ¡ˆ + åˆè§„çš„è¦æ±‚ + å¼€å‘     â”‚    â•‘
   â•‘  â”‚    çš„è®¡åˆ’ â†’ ä¿¡æ¯å®Œæ•´                                â”‚    â•‘
   â•‘  â”‚                                                    â”‚    â•‘
   â•‘  â”‚  AgentOutput:                                      â”‚    â•‘
   â•‘  â”‚    content: "å¥½çš„ï¼Œæˆ‘ä¼šå‡†å¤‡ä»¥ä¸‹æµ‹è¯•ç”¨ä¾‹ï¼š            â”‚    â•‘
   â•‘  â”‚      1. ç”¨æˆ·æ³¨å†Œæµç¨‹æµ‹è¯•                             â”‚    â•‘
   â•‘  â”‚      2. GDPR åŒæ„æœºåˆ¶æµ‹è¯•                            â”‚    â•‘
   â•‘  â”‚      3. æ•°æ®åˆ é™¤è¯·æ±‚æµ‹è¯•"                            â”‚    â•‘
   â•‘  â”‚    next_mentions: []    â† ä¸ @ ä»»ä½•äºº               â”‚    â•‘
   â•‘  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â•‘
   â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   â”‚
7. æ±‡æ€» next_mentions: ç©º
   â”‚  â†’ ä¸ä¼šäº§ç”Ÿ Turn 3
   â”‚  â†’ æ•´ä¸ªå¯¹è¯è½®æ¬¡ç»“æŸ
   â”‚  â†’ ç­‰å¾…äººç±»ä¸‹ä¸€æ¡æ¶ˆæ¯
```

### 9.3 å‰ç«¯æ—¶é—´çº¿è§†è§’ï¼ˆç”¨æˆ·çœ‹åˆ°çš„ï¼‰

```
14:30  ğŸ§‘ ä½ 
       @æ¶æ„å¸ˆ @åˆè§„ è¯·å¸®æˆ‘æ‹†è§£è¿™ä¸ªéœ€æ±‚...

14:31  ğŸ—ï¸ æ¶æ„å¸ˆ                                    â† Turn 1, Phase A
       éœ€æ±‚æ‹†è§£å¦‚ä¸‹ï¼š1. ç”¨æˆ·è®¤è¯æ¨¡å— 2. æƒé™ç®¡ç†æ¨¡å— ...
       @å…¨æ ˆå¼€å‘ è¯·æŒ‰æ­¤æ–¹æ¡ˆå®ç°

14:31  ğŸ“‹ åˆè§„æ£€æŸ¥å‘˜                                  â† Turn 1, Phase Aï¼ˆå‡ ä¹åŒæ—¶ï¼‰
       GDPR åˆè§„è¦æ±‚ï¼š1. éœ€è¦ç”¨æˆ·åŒæ„æœºåˆ¶ ...
       @æµ‹è¯•å·¥ç¨‹å¸ˆ è¯·å‡†å¤‡åˆè§„æµ‹è¯•ç”¨ä¾‹

14:32  ğŸ‘¨â€ğŸ’» å…¨æ ˆå¼€å‘                                    â† Turn 1, Phase B
       æ”¶åˆ°ï¼Œæˆ‘å…ˆå®ç°ç”¨æˆ·è®¤è¯æ¨¡å—ï¼Œä¼šæŒ‰ç…§åˆè§„è¦æ±‚åŠ å…¥åŒæ„æœºåˆ¶ã€‚
       @æµ‹è¯•å·¥ç¨‹å¸ˆ è®¤è¯æ¨¡å—å®Œæˆåè¯·åšå†’çƒŸæµ‹è¯•

14:33  ğŸ§ª æµ‹è¯•å·¥ç¨‹å¸ˆ                                  â† Turn 2, Phase A
       å¥½çš„ï¼Œæˆ‘ä¼šå‡†å¤‡ä»¥ä¸‹æµ‹è¯•ç”¨ä¾‹ï¼š...

       â”€â”€ è‡ªåŠ¨å¯¹è¯ç»“æŸï¼Œç­‰å¾…ä½ çš„ä¸‹ä¸€æ¡æŒ‡ä»¤ â”€â”€
```

### 9.4 å…³é”®è§‚å¯Ÿ

| è¦ç‚¹ | è¯´æ˜ |
|------|------|
| Phase A å†…å¹¶è¡Œ | æ¶æ„å¸ˆå’Œåˆè§„**åŒæ—¶**ç”Ÿæˆå›å¤ï¼Œäº’ç›¸çœ‹ä¸åˆ°å¯¹æ–¹çš„å›å¤ |
| Phase B çœ‹åˆ° Phase A | å¼€å‘åœ¨ Phase B ä¸­ï¼Œèƒ½çœ‹åˆ°æ¶æ„å¸ˆå’Œåˆè§„çš„å›å¤ï¼Œæ‰€ä»¥å®ƒçš„å›å¤èƒ½ç»¼åˆä¸¤è€… |
| æ”¶é½å†å¼€ä¸‹ä¸€ Turn | ä¸æ˜¯æ¶æ„å¸ˆ @ å¼€å‘åç«‹åˆ»è§¦å‘ï¼Œè€Œæ˜¯ç­‰ Turn 1 å…¨éƒ¨å®Œæˆåï¼Œæ±‡æ€» next_mentions |
| å»é‡ | å¼€å‘åœ¨ Turn 1 å·²å›å¤ï¼Œä¸å†å‡ºç°åœ¨ Turn 2 çš„ must_reply ä¸­ |
| ä¿¡æ¯å®Œæ•´æ€§ | æµ‹è¯•åœ¨ Turn 2 ä¸­èƒ½çœ‹åˆ° Turn 1 æ‰€æœ‰äººçš„å›å¤ï¼Œæ‹¿åˆ°å®Œæ•´ä¸Šä¸‹æ–‡ |
| è‡ªç„¶ç»“æŸ | æµ‹è¯•æ²¡æœ‰ next_mentions â†’ æ²¡æœ‰ Turn 3 â†’ ç­‰å¾…äººç±» |

---

## åã€å‰ç«¯ç•Œé¢è®¾è®¡è¦ç‚¹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Agent Arena                                                    [è®¾ç½®] [+ç¾¤ç»„]â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚          â”‚                                          â”‚                        â”‚
â”‚ ç¾¤ç»„åˆ—è¡¨  â”‚            å¯¹è¯ç©ºé—´                       â”‚    å‘˜å·¥çŠ¶æ€é¢æ¿         â”‚
â”‚          â”‚                                          â”‚                        â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â” â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚ â”‚é¡¹ç›®A â”‚ â”‚  â”‚ ğŸ§‘ ä½  (14:30)                      â”‚  â”‚  â”‚ ğŸ—ï¸ æ¶æ„å¸ˆ        â”‚  â”‚
â”‚ â”‚      â”‚ â”‚  â”‚ @æ¶æ„å¸ˆ è¯·å¸®æˆ‘æ‹†è§£è¿™ä¸ªéœ€æ±‚ï¼š        â”‚  â”‚  â”‚ â— generating...  â”‚  â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚ åšä¸€ä¸ªç”¨æˆ·ç®¡ç†ç³»ç»Ÿ                   â”‚  â”‚  â”‚ â–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘ 50%     â”‚  â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â” â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚ â”‚é¡¹ç›®B â”‚ â”‚                                          â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚ â”‚      â”‚ â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚ ğŸ‘¨â€ğŸ’» å…¨æ ˆå¼€å‘      â”‚  â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚ ğŸ—ï¸ æ¶æ„å¸ˆ (14:31)                  â”‚  â”‚  â”‚ â—‹ idle           â”‚  â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â” â”‚  â”‚ å¥½çš„ï¼Œæˆ‘æ¥æ‹†è§£è¿™ä¸ªéœ€æ±‚ï¼š            â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚ â”‚è®¨è®ºç»„ â”‚ â”‚  â”‚ 1. ç”¨æˆ·è®¤è¯æ¨¡å— ...                â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚ â”‚      â”‚ â”‚  â”‚ 2. ç”¨æˆ·ç®¡ç†æ¨¡å— ...                â”‚  â”‚  â”‚ ğŸ§ª æµ‹è¯•å·¥ç¨‹å¸ˆ     â”‚  â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚ @å…¨æ ˆå¼€å‘ è¯·æŒ‰è¿™ä¸ªæ–¹æ¡ˆå®ç°          â”‚  â”‚  â”‚ â—‹ idle           â”‚  â”‚
â”‚          â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚          â”‚                                          â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚          â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚ ğŸ“‹ åˆè§„æ£€æŸ¥å‘˜     â”‚  â”‚
â”‚          â”‚  â”‚ ğŸ‘¨â€ğŸ’» å…¨æ ˆå¼€å‘ (14:33)                â”‚  â”‚  â”‚ â—‹ idle           â”‚  â”‚
â”‚          â”‚  â”‚ æ”¶åˆ°ï¼Œæˆ‘å¼€å§‹å®ç°ç”¨æˆ·è®¤è¯æ¨¡å—...     â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚          â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚                        â”‚
â”‚          â”‚                                          â”‚  â”€â”€ Token ç”¨é‡ â”€â”€      â”‚
â”‚          â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  æœ¬ä¼šè¯: 12,450        â”‚
â”‚          â”‚  â”‚  [è¾“å…¥æ¶ˆæ¯...]           [@] [å‘é€] â”‚  â”‚  é¢„ç®—: 100,000         â”‚
â”‚          â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘ 12%        â”‚
â”‚          â”‚                                          â”‚                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å‰åç«¯é€šä¿¡ï¼š**
- **REST API**ï¼šç¾¤ç»„ CRUDã€æ¶ˆæ¯å†å²æŸ¥è¯¢ã€å‘˜å·¥ç®¡ç†
- **WebSocket**ï¼šå®æ—¶æ¶ˆæ¯æ¨é€ã€å‘˜å·¥çŠ¶æ€æ›´æ–°ã€æµå¼è¾“å‡º

---

## åä¸€ã€é¡¹ç›®ç›®å½•ç»“æ„

```
agent_arena/
â”œâ”€â”€ README.md
â”œâ”€â”€ pyproject.toml                    # Python é¡¹ç›®é…ç½®
â”œâ”€â”€ .env                              # ç¯å¢ƒå˜é‡ï¼ˆAPI Keys ç­‰ï¼‰
â”‚
â”œâ”€â”€ agents/                           # å‘˜å·¥é…ç½®ï¼ˆYAML æ–‡ä»¶ï¼‰
â”‚   â”œâ”€â”€ architect.yaml
â”‚   â”œâ”€â”€ developer.yaml
â”‚   â”œâ”€â”€ tester.yaml
â”‚   â”œâ”€â”€ compliance.yaml
â”‚   â””â”€â”€ supervisor.yaml               # å¯é€‰ï¼šè¶…çº§ç®¡ç†å‘˜
â”‚
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ main.py                       # FastAPI å…¥å£
â”‚   â”‚
â”‚   â”œâ”€â”€ api/                          # API ç½‘å…³å±‚
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ routes_group.py           # ç¾¤ç»„ç›¸å…³è·¯ç”±
â”‚   â”‚   â”œâ”€â”€ routes_message.py         # æ¶ˆæ¯ç›¸å…³è·¯ç”±
â”‚   â”‚   â”œâ”€â”€ routes_agent.py           # å‘˜å·¥ç›¸å…³è·¯ç”±
â”‚   â”‚   â””â”€â”€ websocket.py              # WebSocket ç®¡ç†
â”‚   â”‚
â”‚   â”œâ”€â”€ core/                         # æ ¸å¿ƒä¸šåŠ¡å±‚
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ orchestrator.py           # ç¼–æ’å¼•æ“
â”‚   â”‚   â”œâ”€â”€ context_builder.py        # ä¸Šä¸‹æ–‡æ„å»ºå™¨
â”‚   â”‚   â””â”€â”€ session_manager.py        # ä¼šè¯ç®¡ç†å™¨
â”‚   â”‚
â”‚   â”œâ”€â”€ worker/                       # å‘˜å·¥è¿è¡Œæ—¶
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ runtime.py                # WorkerRuntime
â”‚   â”‚   â””â”€â”€ adapters/                 # Adapter å®ç°
â”‚   â”‚       â”œâ”€â”€ __init__.py
â”‚   â”‚       â”œâ”€â”€ base.py               # BaseAdapter åŸºç±»
â”‚   â”‚       â”œâ”€â”€ anthropic_api.py      # Anthropic API Adapter
â”‚   â”‚       â”œâ”€â”€ openai_api.py         # OpenAI API Adapter
â”‚   â”‚       â”œâ”€â”€ claude_cli.py         # Claude CLI Adapter
â”‚   â”‚       â”œâ”€â”€ cursor_cli.py         # Cursor CLI Adapter
â”‚   â”‚       â””â”€â”€ generic_cli.py        # é€šç”¨ CLI Adapter
â”‚   â”‚
â”‚   â”œâ”€â”€ memory/                       # è®°å¿†ç³»ç»Ÿ
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ store.py                  # MemoryStore
â”‚   â”‚   â””â”€â”€ summarizer.py             # æ‘˜è¦ç”Ÿæˆå™¨
â”‚   â”‚
â”‚   â”œâ”€â”€ registry/                     # å‘˜å·¥ä¸æŠ€èƒ½æ³¨å†Œ
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â””â”€â”€ agent_registry.py         # AgentRegistry
â”‚   â”‚
â”‚   â””â”€â”€ models/                       # æ•°æ®æ¨¡å‹
â”‚       â”œâ”€â”€ __init__.py
â”‚       â”œâ”€â”€ protocol.py               # AgentInput / AgentOutput
â”‚       â”œâ”€â”€ session.py                # Group / Message / Member
â”‚       â””â”€â”€ agent.py                  # AgentProfile / Skill
â”‚
â”œâ”€â”€ data/                             # è¿è¡Œæ—¶æ•°æ®ï¼ˆ.gitignoreï¼‰
â”‚   â”œâ”€â”€ agent_arena.db                # SQLite æ•°æ®åº“
â”‚   â”œâ”€â”€ memory/                       # è®°å¿†å¿«ç…§
â”‚   â””â”€â”€ attachments/                  # é™„ä»¶æ–‡ä»¶
â”‚
â”œâ”€â”€ frontend/                         # å‰ç«¯é¡¹ç›®ï¼ˆç‹¬ç«‹ï¼‰
â”‚   â”œâ”€â”€ package.json
â”‚   â”œâ”€â”€ src/
â”‚   â””â”€â”€ ...
â”‚
â””â”€â”€ tests/                            # æµ‹è¯•
    â”œâ”€â”€ test_orchestrator.py
    â”œâ”€â”€ test_context_builder.py
    â”œâ”€â”€ test_adapters.py
    â””â”€â”€ ...
```

---

## åäºŒã€ä¸ä½ éšæƒ³çš„é€æ¡å¯¹åº”

| ä½ çš„æƒ³æ³• | æ¶æ„ä¸­çš„è½ç‚¹ |
|---------|-------------|
| å‘˜å·¥ = CLI è¿›ç¨‹ï¼ŒåŒ CLI å¤šå‘˜å·¥ | WorkerRuntime ç®¡ç†è¿›ç¨‹ï¼ŒAgentRegistry æ”¯æŒåŒä¸€ adapter_type åˆ›å»ºå¤šä¸ªå‘˜å·¥ |
| å·¦ä¾§ç¾¤ç»„ / ä¸­é—´å¯¹è¯ / å³ä¾§çŠ¶æ€ | å‰ç«¯ä¸‰æ å¸ƒå±€ï¼ŒWebSocket é©±åŠ¨å®æ—¶æ›´æ–° |
| @ å‘˜å·¥ / @all / å‘˜å·¥äº’ @ | Orchestrator è§£æ mentions â†’ must_reply / may_replyï¼›Agent é€šè¿‡ next_mentions é“¾å¼ @ |
| å“åº”æƒé™åœ¨å‘é€æ–¹ vs æ¥æ”¶æ–¹ | æ··åˆæ¨¡å¼ï¼šè¢« @ çš„å¿…é¡»å›ï¼ˆå‘é€æ–¹æƒé™ï¼‰+ å…¶ä½™è‡ªä¸»åˆ¤æ–­ï¼ˆæ¥æ”¶æ–¹æƒé™ï¼‰ |
| è¶…çº§ç®¡ç†å‘˜ç»Ÿä¸€æ´¾æ´» | å¯é€‰çš„ Supervisor æ¨¡å¼ï¼ŒæŒ‰ç¾¤ç»„é…ç½®å¼€å…³ |
| å…¥å‚/å‡ºå‚ç»Ÿä¸€ | AgentInput / AgentOutput åè®® + BaseAdapter æ¥å£ |
| è§’è‰²ï¼ˆPM/æ¶æ„/å¼€å‘/æµ‹è¯•/åˆè§„ï¼‰ | AgentRegistry çš„ YAML é…ç½®ï¼Œæ¯ä¸ªè§’è‰²ä¸€ä¸ªæ–‡ä»¶ |
| è®°å¿†æ¨¡å—ï¼ŒæŒ‰ä¼šè¯è¿˜æ˜¯æŒ‰å‘˜å·¥ | **æŒ‰ä¼šè¯å­˜å‚¨**ï¼Œå‘˜å·¥æ— çŠ¶æ€ï¼Œè°ƒç”¨æ—¶ç”± ContextBuilder æ³¨å…¥ |
| Token èŠ‚çœ | ContextBuilder å››å±‚ç­–ç•¥ï¼šæˆªæ–­ â†’ æ‘˜è¦ â†’ è®°å¿†æ£€ç´¢ â†’ ç®€æ´å¼•å¯¼ |
| å³ä¾§åŠ¨ç”»ï¼ˆåœ¨å¹²å•¥ï¼‰ | WorkerRuntime çš„ emit_status + å‰ç«¯çŠ¶æ€æœºæ˜ å°„åŠ¨ç”» |
| å¯æ‰©å±•ã€é€‚é…ä¸»æµ CLI | BaseAdapter æ¥å£ + æ–°å¢ YAML é…ç½®æ–‡ä»¶å³å¯ |
| ä¸å¤šæ™ºèƒ½ä½“ç¼–æ’æ¡†æ¶çš„åŒºåˆ« | æ˜ç¡®åŒºåˆ†ï¼šæˆ‘ä»¬æ˜¯ã€Œåä½œå¹³å°ã€ä¸æ˜¯ã€Œç¼–æ’æ¡†æ¶ã€ï¼Œæ¯ä¸ªå‘˜å·¥æœ¬èº«å°±æ˜¯å®Œæ•´ Agent |

---

## åä¸‰ã€è¡¥å……è®¾è®¡ï¼ˆä½ æ²¡æä½†å¾ˆé‡è¦çš„ï¼‰

### 13.1 å®¡è®¡æ—¥å¿—

æ‰€æœ‰ Agent çš„è¾“å…¥è¾“å‡ºéƒ½åº”è¯¥è®°å½•ï¼Œä¾¿äºï¼š
- åˆè§„æ£€æŸ¥å‘˜ Agent ç”Ÿæˆåˆè§„æŠ¥å‘Šï¼ˆä½¿ç”¨çœŸå®è®°å½•è€Œéå‡­ç©ºç¼–é€ ï¼‰
- å‡ºäº†é—®é¢˜å¯ä»¥å›æº¯
- Token ç”¨é‡ç»Ÿè®¡

```python
class AuditLog:
    turn_id: str
    agent_id: str
    input_tokens: int
    output_tokens: int
    input_hash: str          # ä¸å­˜åŸæ–‡ï¼Œå­˜ hashï¼ŒèŠ‚çœç©ºé—´
    output_content: str      # è¾“å‡ºéœ€è¦å­˜åŸæ–‡ï¼ˆç”¨äºåˆè§„å®¡æŸ¥ï¼‰
    latency_ms: int
    status: Literal["success", "timeout", "error"]
    timestamp: datetime
```

### 13.2 äººç±»ç¡®è®¤æœºåˆ¶

æŸäº›é«˜é£é™©æ“ä½œï¼ˆå¦‚ Agent è¦æ‰§è¡Œå‘½ä»¤ã€ä¿®æ”¹æ–‡ä»¶ã€è°ƒç”¨å¤–éƒ¨ APIï¼‰ï¼Œç³»ç»Ÿå¯ä»¥æ‹¦æˆªå¹¶è¦æ±‚äººç±»ç¡®è®¤ï¼š

```python
class HumanApprovalConfig:
    require_approval_for: list[str] = [
        "execute_command",       # æ‰§è¡Œç³»ç»Ÿå‘½ä»¤
        "modify_file",           # ä¿®æ”¹æ–‡ä»¶
        "external_api_call",     # è°ƒç”¨å¤–éƒ¨æœåŠ¡
        "deploy",                # éƒ¨ç½²æ“ä½œ
    ]
```

### 13.3 ç¾¤ç»„æ¨¡æ¿

é¢„å®šä¹‰ä¸€äº›å¸¸ç”¨çš„ç¾¤ç»„æ¨¡æ¿ï¼Œå¿«é€Ÿåˆ›å»ºå¸¦æœ‰é»˜è®¤å‘˜å·¥é…ç½®çš„ç¾¤ç»„ï¼š

```yaml
# templates/software_dev.yaml
template_name: "è½¯ä»¶å¼€å‘é¡¹ç›®"
description: "é€‚ç”¨äºè½¯ä»¶å¼€å‘çš„æ ‡å‡†å›¢é˜Ÿé…ç½®"
default_members:
  - agent_id: "architect"
    role_in_group: "æ¶æ„å¸ˆï¼Œè´Ÿè´£éœ€æ±‚åˆ†æå’Œæ–¹æ¡ˆè®¾è®¡"
  - agent_id: "developer"
    role_in_group: "å…¨æ ˆå¼€å‘ï¼Œè´Ÿè´£ä»£ç å®ç°"
  - agent_id: "tester"
    role_in_group: "æµ‹è¯•å·¥ç¨‹å¸ˆï¼Œè´Ÿè´£è´¨é‡ä¿éšœ"
  - agent_id: "compliance"
    role_in_group: "åˆè§„æ£€æŸ¥å‘˜ï¼Œè´Ÿè´£æµç¨‹åˆè§„"
config:
  max_responders: 3
  supervisor_enabled: false
  auto_summary_interval: 20       # æ¯ 20 æ¡æ¶ˆæ¯è‡ªåŠ¨ç”Ÿæˆæ‘˜è¦
```

### 13.4 æ¶ˆæ¯æ ¼å¼æ‰©å±•

Agent çš„å›å¤é™¤äº†çº¯æ–‡æœ¬ï¼Œè¿˜å¯ä»¥åŒ…å«ç»“æ„åŒ–å†…å®¹ï¼š

```python
class StructuredContent:
    """Agent å¯ä»¥è¿”å›ç»“æ„åŒ–å†…å®¹ï¼Œå‰ç«¯æ®æ­¤åšç‰¹æ®Šæ¸²æŸ“"""
    type: Literal[
        "task_list",          # ä»»åŠ¡åˆ—è¡¨ï¼ˆå‰ç«¯æ¸²æŸ“ä¸º checklistï¼‰
        "code_block",         # ä»£ç å—ï¼ˆå‰ç«¯æ¸²æŸ“ä¸ºä»£ç ç¼–è¾‘å™¨ï¼‰
        "architecture_diagram",  # æ¶æ„å›¾ï¼ˆå‰ç«¯æ¸²æŸ“ä¸º Mermaid å›¾ï¼‰
        "diff",               # ä»£ç  diff
        "approval_request",   # å®¡æ‰¹è¯·æ±‚ï¼ˆå‰ç«¯æ¸²æŸ“ä¸ºå®¡æ‰¹æŒ‰é’®ï¼‰
    ]
    data: dict
```

---

## åå››ã€å®æ–½è·¯çº¿

### Phase 1: æœ€å°å¯ç”¨ï¼ˆ2~3 å‘¨ï¼‰
- [ ] å®šä¹‰ AgentInput / AgentOutput åè®®ï¼ˆ`models/protocol.py`ï¼‰
- [ ] å®ç°ä¸€ä¸ª Adapterï¼ˆæ¨èå…ˆåš `AnthropicApiAdapter`ï¼Œæœ€ç®€å•ï¼‰
- [ ] å®ç° SessionManagerï¼ˆSQLite + åŸºæœ¬ CRUDï¼‰
- [ ] å®ç° Orchestratorï¼ˆä»…æ”¯æŒ @ æŸäºº â†’ must_replyï¼‰
- [ ] å®ç° ContextBuilderï¼ˆä»…åšæ¶ˆæ¯æˆªæ–­ï¼Œä¸åšè®°å¿†ï¼‰
- [ ] å®ç° WorkerRuntimeï¼ˆå• Agent è°ƒç”¨ï¼‰
- [ ] å‰ç«¯ï¼šæœ€ç®€å•çš„èŠå¤©ç•Œé¢ + 1 ä¸ª Agent

**äº¤ä»˜ç‰©ï¼š** èƒ½å’Œ 1 ä¸ª AI å‘˜å·¥å¯¹è¯çš„æœ€ç®€ç³»ç»Ÿã€‚

### Phase 2: å¤šå‘˜å·¥åä½œï¼ˆ2~3 å‘¨ï¼‰
- [ ] æ”¯æŒå¤š Agentã€å¤šç¾¤ç»„
- [ ] Orchestrator æ”¯æŒ may_reply è‡ªä¸»åˆ¤æ–­
- [ ] æ”¯æŒ Agent é“¾å¼ @ï¼ˆnext_mentionsï¼‰
- [ ] é˜²å¾ªç¯ã€è¶…æ—¶ç­‰é˜²æŠ¤æœºåˆ¶
- [ ] å‰ç«¯ä¸‰æ å¸ƒå±€ + å‘˜å·¥çŠ¶æ€é¢æ¿

**äº¤ä»˜ç‰©ï¼š** å¤šä¸ª AI å‘˜å·¥èƒ½åœ¨ç¾¤é‡Œåä½œã€‚

### Phase 3: è®°å¿†ä¸ä¼˜åŒ–ï¼ˆ2~3 å‘¨ï¼‰
- [ ] è®°å¿†ç³»ç»Ÿï¼šä¿å­˜å…³é”®ä¿¡æ¯ã€è¯­ä¹‰æ£€ç´¢
- [ ] å†å²æ‘˜è¦ç”Ÿæˆ
- [ ] Token é¢„ç®—ç®¡ç†
- [ ] å®¡è®¡æ—¥å¿—
- [ ] æ›´å¤š Adapterï¼ˆClaude CLIã€OpenAI API ç­‰ï¼‰

**äº¤ä»˜ç‰©ï¼š** æœ‰è®°å¿†çš„ã€Token å‹å¥½çš„åä½œç³»ç»Ÿã€‚

### Phase 4: ä½“éªŒæ‰“ç£¨ï¼ˆæŒç»­ï¼‰
- [ ] å³ä¾§å‘˜å·¥çŠ¶æ€åŠ¨ç”»
- [ ] ç¾¤ç»„æ¨¡æ¿
- [ ] äººç±»ç¡®è®¤æœºåˆ¶
- [ ] Supervisor æ¨¡å¼
- [ ] ç»“æ„åŒ–æ¶ˆæ¯æ¸²æŸ“
- [ ] æ€§èƒ½ä¼˜åŒ–ã€ç›‘æ§
